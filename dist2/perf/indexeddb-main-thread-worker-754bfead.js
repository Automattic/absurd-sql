function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgbGV0IEZJTkFMSVpFRCA9IDB4ZGVhZGJlZWY7CgogIGxldCBXUklURUFCTEUgPSAwOwogIGxldCBSRUFEQUJMRSA9IDE7CgogIGNsYXNzIFJlYWRlciB7CiAgICBjb25zdHJ1Y3RvcigKICAgICAgYnVmZmVyLAogICAgICB7IGluaXRpYWxPZmZzZXQgPSA0LCB1c2VBdG9taWNzID0gdHJ1ZSwgc3RyZWFtID0gdHJ1ZSwgZGVidWcsIG5hbWUgfSA9IHt9CiAgICApIHsKICAgICAgdGhpcy5idWZmZXIgPSBidWZmZXI7CiAgICAgIHRoaXMuYXRvbWljVmlldyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlcik7CiAgICAgIHRoaXMub2Zmc2V0ID0gaW5pdGlhbE9mZnNldDsKICAgICAgdGhpcy51c2VBdG9taWNzID0gdXNlQXRvbWljczsKICAgICAgdGhpcy5zdHJlYW0gPSBzdHJlYW07CiAgICAgIHRoaXMuZGVidWcgPSBkZWJ1ZzsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIH0KCiAgICBsb2coLi4uYXJncykgewogICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbcmVhZGVyOiAke3RoaXMubmFtZX1dYCwgLi4uYXJncyk7CiAgICAgIH0KICAgIH0KCiAgICB3YWl0V3JpdGUobmFtZSkgewogICAgICBpZiAodGhpcy51c2VBdG9taWNzKSB7CiAgICAgICAgdGhpcy5sb2coYHdhaXRpbmcgZm9yICR7bmFtZX1gKTsKCiAgICAgICAgd2hpbGUgKEF0b21pY3MubG9hZCh0aGlzLmF0b21pY1ZpZXcsIDApID09PSBXUklURUFCTEUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd3YWl0aW5nIGZvciB3cml0ZS4uLicpOwogICAgICAgICAgQXRvbWljcy53YWl0KHRoaXMuYXRvbWljVmlldywgMCwgV1JJVEVBQkxFLCA1MDApOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5sb2coYHJlc3VtZWQgZm9yICR7bmFtZX1gKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5hdG9taWNWaWV3WzBdICE9PSBSRUFEQUJMRSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgd2FpdFdyaXRlYCBleHBlY3RlZCBhcnJheSB0byBiZSByZWFkYWJsZScpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZsaXAoKSB7CiAgICAgIHRoaXMubG9nKCdmbGlwJyk7CiAgICAgIGlmICh0aGlzLnVzZUF0b21pY3MpIHsKICAgICAgICBsZXQgcHJldiA9IEF0b21pY3MuY29tcGFyZUV4Y2hhbmdlKAogICAgICAgICAgdGhpcy5hdG9taWNWaWV3LAogICAgICAgICAgMCwKICAgICAgICAgIFJFQURBQkxFLAogICAgICAgICAgV1JJVEVBQkxFCiAgICAgICAgKTsKCiAgICAgICAgaWYgKHByZXYgIT09IFJFQURBQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlYWQgZGF0YSBvdXQgb2Ygc3luYyEgVGhpcyBpcyBkaXNhc3Ryb3VzJyk7CiAgICAgICAgfQoKICAgICAgICBBdG9taWNzLm5vdGlmeSh0aGlzLmF0b21pY1ZpZXcsIDApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXRvbWljVmlld1swXSA9IFdSSVRFQUJMRTsKICAgICAgfQoKICAgICAgdGhpcy5vZmZzZXQgPSA0OwogICAgfQoKICAgIGRvbmUoKSB7CiAgICAgIHRoaXMud2FpdFdyaXRlKCdkb25lJyk7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KTsKICAgICAgbGV0IGRvbmUgPSBkYXRhVmlldy5nZXRVaW50MzIoMCkgPT09IEZJTkFMSVpFRDsKCiAgICAgIGlmIChkb25lKSB7CiAgICAgICAgdGhpcy5sb2coJ2RvbmUnKTsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRvbmU7CiAgICB9CgogICAgcGVlayhmbikgewogICAgICB0aGlzLnBlZWtPZmZzZXQgPSB0aGlzLm9mZnNldDsKICAgICAgbGV0IHJlcyA9IGZuKCk7CiAgICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5wZWVrT2Zmc2V0OwogICAgICB0aGlzLnBlZWtPZmZzZXQgPSBudWxsOwogICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIHN0cmluZygpIHsKICAgICAgdGhpcy53YWl0V3JpdGUoJ3N0cmluZycpOwoKICAgICAgbGV0IGJ5dGVMZW5ndGggPSB0aGlzLl9pbnQzMigpOwogICAgICBsZXQgbGVuZ3RoID0gYnl0ZUxlbmd0aCAvIDI7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgbGV0IGNoYXJzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjaGFycy5wdXNoKGRhdGFWaWV3LmdldFVpbnQxNihpICogMikpOwogICAgICB9CiAgICAgIGxldCBzdHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGNoYXJzKTsKICAgICAgdGhpcy5sb2coJ3N0cmluZycsIHN0cik7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwoKICAgICAgaWYgKHRoaXMucGVla09mZnNldCA9PSBudWxsKSB7CiAgICAgICAgdGhpcy5mbGlwKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0cjsKICAgIH0KCiAgICBfaW50MzIoKSB7CiAgICAgIGxldCBieXRlTGVuZ3RoID0gNDsKCiAgICAgIGxldCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQpOwogICAgICBsZXQgbnVtID0gZGF0YVZpZXcuZ2V0SW50MzIoKTsKICAgICAgdGhpcy5sb2coJ19pbnQzMicsIG51bSk7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwogICAgICByZXR1cm4gbnVtOwogICAgfQoKICAgIGludDMyKCkgewogICAgICB0aGlzLndhaXRXcml0ZSgnaW50MzInKTsKICAgICAgbGV0IG51bSA9IHRoaXMuX2ludDMyKCk7CiAgICAgIHRoaXMubG9nKCdpbnQzMicsIG51bSk7CgogICAgICBpZiAodGhpcy5wZWVrT2Zmc2V0ID09IG51bGwpIHsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQogICAgICByZXR1cm4gbnVtOwogICAgfQoKICAgIGJ5dGVzKCkgewogICAgICB0aGlzLndhaXRXcml0ZSgnYnl0ZXMnKTsKCiAgICAgIGxldCBieXRlTGVuZ3RoID0gdGhpcy5faW50MzIoKTsKCiAgICAgIGxldCBieXRlcyA9IG5ldyBBcnJheUJ1ZmZlcihieXRlTGVuZ3RoKTsKICAgICAgbmV3IFVpbnQ4QXJyYXkoYnl0ZXMpLnNldCgKICAgICAgICBuZXcgVWludDhBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQsIGJ5dGVMZW5ndGgpCiAgICAgICk7CiAgICAgIHRoaXMubG9nKCdieXRlcycsIGJ5dGVzKTsKCiAgICAgIHRoaXMub2Zmc2V0ICs9IGJ5dGVMZW5ndGg7CgogICAgICBpZiAodGhpcy5wZWVrT2Zmc2V0ID09IG51bGwpIHsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQogICAgICByZXR1cm4gYnl0ZXM7CiAgICB9CiAgfQoKICBjbGFzcyBXcml0ZXIgewogICAgY29uc3RydWN0b3IoCiAgICAgIGJ1ZmZlciwKICAgICAgeyBpbml0aWFsT2Zmc2V0ID0gNCwgdXNlQXRvbWljcyA9IHRydWUsIHN0cmVhbSA9IHRydWUsIGRlYnVnLCBuYW1lIH0gPSB7fQogICAgKSB7CiAgICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyOwogICAgICB0aGlzLmF0b21pY1ZpZXcgPSBuZXcgSW50MzJBcnJheShidWZmZXIpOwogICAgICB0aGlzLm9mZnNldCA9IGluaXRpYWxPZmZzZXQ7CiAgICAgIHRoaXMudXNlQXRvbWljcyA9IHVzZUF0b21pY3M7CiAgICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwoKICAgICAgdGhpcy5kZWJ1ZyA9IGRlYnVnOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwoKICAgICAgaWYgKHRoaXMudXNlQXRvbWljcykgewogICAgICAgIC8vIFRoZSBidWZmZXIgc3RhcnRzIG91dCBhcyB3cml0ZWFibGUKICAgICAgICBBdG9taWNzLnN0b3JlKHRoaXMuYXRvbWljVmlldywgMCwgV1JJVEVBQkxFKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmF0b21pY1ZpZXdbMF0gPSBXUklURUFCTEU7CiAgICAgIH0KICAgIH0KCiAgICBsb2coLi4uYXJncykgewogICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbd3JpdGVyOiAke3RoaXMubmFtZX1dYCwgLi4uYXJncyk7CiAgICAgIH0KICAgIH0KCiAgICB3YWl0UmVhZChuYW1lKSB7CiAgICAgIGlmICh0aGlzLnVzZUF0b21pY3MpIHsKICAgICAgICB0aGlzLmxvZyhgd2FpdGluZyBmb3IgJHtuYW1lfWApOwogICAgICAgIC8vIFN3aXRjaCB0byB3cml0YWJsZQogICAgICAgIC8vIEF0b21pY3Muc3RvcmUodGhpcy5hdG9taWNWaWV3LCAwLCAxKTsKCiAgICAgICAgbGV0IHByZXYgPSBBdG9taWNzLmNvbXBhcmVFeGNoYW5nZSgKICAgICAgICAgIHRoaXMuYXRvbWljVmlldywKICAgICAgICAgIDAsCiAgICAgICAgICBXUklURUFCTEUsCiAgICAgICAgICBSRUFEQUJMRQogICAgICAgICk7CgogICAgICAgIGlmIChwcmV2ICE9PSBXUklURUFCTEUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1dyb3RlIHNvbWV0aGluZyBpbnRvIHVud3JpdGFibGUgYnVmZmVyISBUaGlzIGlzIGRpc2FzdHJvdXMnCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgQXRvbWljcy5ub3RpZnkodGhpcy5hdG9taWNWaWV3LCAwKTsKCiAgICAgICAgd2hpbGUgKEF0b21pY3MubG9hZCh0aGlzLmF0b21pY1ZpZXcsIDApID09PSBSRUFEQUJMRSkgewogICAgICAgICAgLy8gY29uc29sZS5sb2coJ3dhaXRpbmcgdG8gYmUgcmVhZC4uLicpOwogICAgICAgICAgQXRvbWljcy53YWl0KHRoaXMuYXRvbWljVmlldywgMCwgUkVBREFCTEUsIDUwMCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmxvZyhgcmVzdW1lZCBmb3IgJHtuYW1lfWApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXRvbWljVmlld1swXSA9IFJFQURBQkxFOwogICAgICB9CgogICAgICB0aGlzLm9mZnNldCA9IDQ7CiAgICB9CgogICAgZmluYWxpemUoKSB7CiAgICAgIHRoaXMubG9nKCdmaW5hbGl6aW5nJyk7CiAgICAgIGxldCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQpOwogICAgICBkYXRhVmlldy5zZXRVaW50MzIoMCwgRklOQUxJWkVEKTsKICAgICAgdGhpcy53YWl0UmVhZCgnZmluYWxpemUnKTsKICAgIH0KCiAgICBzdHJpbmcoc3RyKSB7CiAgICAgIHRoaXMubG9nKCdzdHJpbmcnLCBzdHIpOwoKICAgICAgbGV0IGJ5dGVMZW5ndGggPSBzdHIubGVuZ3RoICogMjsKICAgICAgdGhpcy5faW50MzIoYnl0ZUxlbmd0aCk7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MTYoaSAqIDIsIHN0ci5jaGFyQ29kZUF0KGkpKTsKICAgICAgfQoKICAgICAgdGhpcy5vZmZzZXQgKz0gYnl0ZUxlbmd0aDsKICAgICAgdGhpcy53YWl0UmVhZCgnc3RyaW5nJyk7CiAgICB9CgogICAgX2ludDMyKG51bSkgewogICAgICBsZXQgYnl0ZUxlbmd0aCA9IDQ7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KTsKICAgICAgZGF0YVZpZXcuc2V0SW50MzIoMCwgbnVtKTsKCiAgICAgIHRoaXMub2Zmc2V0ICs9IGJ5dGVMZW5ndGg7CiAgICB9CgogICAgaW50MzIobnVtKSB7CiAgICAgIHRoaXMubG9nKCdpbnQzMicsIG51bSk7CiAgICAgIHRoaXMuX2ludDMyKG51bSk7CiAgICAgIHRoaXMud2FpdFJlYWQoJ2ludDMyJyk7CiAgICB9CgogICAgYnl0ZXMoYnVmZmVyKSB7CiAgICAgIHRoaXMubG9nKCdieXRlcycsIGJ1ZmZlcik7CgogICAgICBsZXQgYnl0ZUxlbmd0aCA9IGJ1ZmZlci5ieXRlTGVuZ3RoOwogICAgICB0aGlzLl9pbnQzMihieXRlTGVuZ3RoKTsKICAgICAgbmV3IFVpbnQ4QXJyYXkodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KS5zZXQobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSk7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwogICAgICB0aGlzLndhaXRSZWFkKCdieXRlcycpOwogICAgfQogIH0KCiAgbGV0IGJ1ZmZlciA9IDQwMDAwOwogIGxldCBiYXNlVGltZTsKICBsZXQgdGltaW5ncyA9IHt9OwogIGxldCBjb3VudHMgPSB7fTsKCiAgYXN5bmMgZnVuY3Rpb24gd3JpdGVEYXRhKHR5cGUsIG5hbWUsIGRhdGEpIHsKICAgIGdsb2JhbFRoaXMucG9zdE1lc3NhZ2UoewogICAgICB0eXBlOiAnX19wZXJmLWRlZXRzOmxvZy1wZXJmJywKICAgICAgZGF0YVR5cGU6IHR5cGUsCiAgICAgIG5hbWUsCiAgICAgIGRhdGEKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gc3RhcnQoKSB7CiAgICBnbG9iYWxUaGlzLnBvc3RNZXNzYWdlKHsgdHlwZTogJ19fcGVyZi1kZWV0czpjbGVhci1wZXJmJyB9KTsKCiAgICB0aW1pbmdzID0ge307CiAgICBjb3VudHMgPSB7fTsKICAgIGJhc2VUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBzdG9wKCkgewogICAgT2JqZWN0LmtleXModGltaW5ncykubWFwKG5hbWUgPT4gewogICAgICBsZXQgdGltaW5nID0gdGltaW5nc1tuYW1lXTsKICAgICAgd3JpdGVEYXRhKAogICAgICAgICd0aW1pbmcnLAogICAgICAgIG5hbWUsCiAgICAgICAgdGltaW5nLmRhdGEubWFwKHggPT4gKHsgeDogeC5zdGFydCArIHgudG9vaywgeTogeC50b29rIH0pKQogICAgICApOwogICAgfSk7CgogICAgT2JqZWN0LmtleXMoY291bnRzKS5tYXAobmFtZSA9PiB7CiAgICAgIGxldCBjb3VudCA9IGNvdW50c1tuYW1lXTsKICAgICAgd3JpdGVEYXRhKCdjb3VudCcsIG5hbWUsIGNvdW50Lm1hcCgoYywgaSkgPT4gKHsgeDogYy50aW1lLCB5OiBpIH0pKSk7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIHJlY29yZChuYW1lKSB7CiAgICBpZiAodGltaW5nc1tuYW1lXSA9PSBudWxsKSB7CiAgICAgIHRpbWluZ3NbbmFtZV0gPSB7IHN0YXJ0OiBudWxsLCBkYXRhOiBbXSB9OwogICAgfQogICAgbGV0IHRpbWVyID0gdGltaW5nc1tuYW1lXTsKCiAgICBpZiAodGltZXIuc3RhcnQgIT0gbnVsbCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IoYHRpbWVyIGFscmVhZHkgc3RhcnRlZCAke25hbWV9YCk7CiAgICB9CiAgICB0aW1lci5zdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpOwogIH0KCiAgZnVuY3Rpb24gZW5kUmVjb3JkaW5nKG5hbWUpIHsKICAgIGxldCBub3cgPSBwZXJmb3JtYW5jZS5ub3coKTsKICAgIGxldCB0aW1lciA9IHRpbWluZ3NbbmFtZV07CgogICAgaWYgKHRpbWVyICYmIHRpbWVyLnN0YXJ0ICE9IG51bGwpIHsKICAgICAgbGV0IHRvb2sgPSBub3cgLSB0aW1lci5zdGFydDsKICAgICAgbGV0IHN0YXJ0ID0gdGltZXIuc3RhcnQgLSBiYXNlVGltZTsKICAgICAgdGltZXIuc3RhcnQgPSBudWxsOwoKICAgICAgaWYgKHRpbWVyLmRhdGEubGVuZ3RoIDwgYnVmZmVyKSB7CiAgICAgICAgdGltZXIuZGF0YS5wdXNoKHsgc3RhcnQsIHRvb2sgfSk7CiAgICAgIH0KICAgIH0KICB9CgogIGZ1bmN0aW9uIGNvdW50KG5hbWUpIHsKICAgIGlmIChjb3VudHNbbmFtZV0gPT0gbnVsbCkgewogICAgICBjb3VudHNbbmFtZV0gPSBbXTsKICAgIH0KICAgIGNvdW50c1tuYW1lXS5wdXNoKHsgdGltZTogcGVyZm9ybWFuY2Uubm93KCkgfSk7CiAgfQoKICAvLyBBZGQgYSBsaXN0ZW5lciB0byBoYW5kbGUgc3RhcnQvc3RvcCBldmVudHMKICBnbG9iYWxUaGlzLmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCBlID0+IHsKICAgIHN3aXRjaCAoZS5kYXRhLnR5cGUpIHsKICAgICAgY2FzZSAnX19wZXJmLWRlZXRzOnN0YXJ0LXByb2ZpbGUnOgogICAgICAgIHN0YXJ0KCk7CiAgICAgICAgYnJlYWs7CiAgICAgIGNhc2UgJ19fcGVyZi1kZWV0czpzdG9wLXByb2ZpbGUnOgogICAgICAgIHN0b3AoKTsKICAgICAgICBicmVhazsKICAgICAgLy8gSW4gdGhlIGNhc2Ugb2YgbmVzdGVkIHdvcmtlcnMsIHdlIHdhbnQgdG8gcHJvcGFnYXRlIHRoZXNlCiAgICAgIC8vIGV2ZW50cyB1cCB0byB0aGUgbWFpbiB0aHJlYWQuIE5vdGUgdGhhdCB0aGlzIGFzc3VtZXMgdGhlIHBlcmYKICAgICAgLy8gbGlicmFyeSBpcyBsb2FkZWQgdGhyb3VnaG91dCB0aGUgd2hvbGUgd29ya2VyIHRyZWUuIElmIG9uZSBvZgogICAgICAvLyB0aGUgY2hpbGQgd29ya2VycyBkb2Vzbid0IGxvYWQsIHRoaXMgbGlzdGVuZXIgd29uJ3QgcnVuIGFuZAogICAgICAvLyBkYXRhIHdpbGwgYmUgbG9zdAogICAgICBjYXNlICdfX3BlcmYtZGVldHM6Y2xlYXItcGVyZic6CiAgICAgIGNhc2UgJ19fcGVyZi1kZWV0czpsb2ctcGVyZic6CiAgICAgICAgc2VsZi5wb3N0TWVzc2FnZShlLmRhdGEpOwogICAgfQogIH0pOwoKICBsZXQgaXNQcm9iYWJseVNhZmFyaSA9IC9eKCg/IWNocm9tZXxhbmRyb2lkKS4pKnNhZmFyaS9pLnRlc3QoCiAgICBuYXZpZ2F0b3IudXNlckFnZW50CiAgKTsKCiAgbGV0IG9wZW5EYnMgPSBuZXcgTWFwKCk7CiAgbGV0IHRyYW5zYWN0aW9ucyA9IG5ldyBNYXAoKTsKCiAgZnVuY3Rpb24gYXNzZXJ0KGNvbmQsIG1zZykgewogICAgaWYgKCFjb25kKSB7CiAgICAgIHRocm93IG5ldyBFcnJvcihtc2cpOwogICAgfQogIH0KCiAgbGV0IExPQ0tfVFlQRVMgPSB7CiAgICBOT05FOiAwLAogICAgU0hBUkVEOiAxLAogICAgUkVTRVJWRUQ6IDIsCiAgICBQRU5ESU5HOiAzLAogICAgRVhDTFVTSVZFOiA0CiAgfTsKCiAgLy8gV2UgdXNlIGxvbmctbGl2ZWQgdHJhbnNhY3Rpb25zLCBhbmQgYFRyYW5zYWN0aW9uYCBrZWVwcyB0aGUKICAvLyB0cmFuc2FjdGlvbiBzdGF0ZS4gSXQgaW1wbGVtZW50cyBhbiBvcHRpbWFsIHdheSB0byBwZXJmb3JtCiAgLy8gcmVhZC93cml0ZXMgd2l0aCBrbm93bGVkZ2Ugb2YgaG93IHNxbGl0ZSBhc2tzIGZvciB0aGVtLCBhbmQgYWxzbwogIC8vIGltcGxlbWVudHMgYSBsb2NraW5nIG1lY2hhbmlzbSB0aGF0IG1hcHMgdG8gaG93IHNxbGl0ZSBsb2NrcyB3b3JrLgogIGNsYXNzIFRyYW5zYWN0aW9uIHsKICAgIGNvbnN0cnVjdG9yKGRiLCBpbml0aWFsTW9kZSA9ICdyZWFkb25seScpIHsKICAgICAgdGhpcy5kYiA9IGRiOwogICAgICBjb3VudCgndHJhbnNhY3Rpb25zJyk7CiAgICAgIHRoaXMudHJhbnMgPSB0aGlzLmRiLnRyYW5zYWN0aW9uKFsnZGF0YSddLCBpbml0aWFsTW9kZSk7CiAgICAgIHRoaXMuc3RvcmUgPSB0aGlzLnRyYW5zLm9iamVjdFN0b3JlKCdkYXRhJyk7CiAgICAgIHRoaXMubG9ja1R5cGUgPQogICAgICAgIGluaXRpYWxNb2RlID09PSAncmVhZG9ubHknID8gTE9DS19UWVBFUy5TSEFSRUQgOiBMT0NLX1RZUEVTLkVYQ0xVU0lWRTsKCiAgICAgIC8vIFRoZXJlIGlzIG5vIG5lZWQgZm9yIHVzIHRvIGNhY2hlIGJsb2Nrcy4gVXNlIHNxbGl0ZSdzCiAgICAgIC8vIGBjYWNoZV9zaXplYCBmb3IgdGhhdCBhbmQgaXQgd2lsbCBhdXRvbWF0aWNhbGx5IGRvIGl0LiBIb3dldmVyLAogICAgICAvLyB3ZSBkbyBzdGlsbCBrZWVwIGEgY2FjaGUgb2YgdGhlIGZpcnN0IGJsb2NrIGZvciB0aGUgZHVyYXRpb24gb2YKICAgICAgLy8gdGhpcyB0cmFuc2FjdGlvbiBiZWNhdXNlIG9mIGhvdyBsb2NraW5nIHdvcmtzOyB0aGlzIGF2b2lkcyBhCiAgICAgIC8vIGZldyBleHRyYSByZWFkcyBhbmQgYWxsb3dzIHVzIHRvIGRldGVjdCBjaGFuZ2VzIGR1cmluZwogICAgICAvLyB1cGdyYWRpbmcgKHNlZSBgdXBncmFkZUV4Y2x1c2l2ZWApCiAgICAgIHRoaXMuY2FjaGVkRmlyc3RCbG9jayA9IG51bGw7CgogICAgICB0aGlzLmN1cnNvciA9IG51bGw7CiAgICAgIHRoaXMucHJldlJlYWRzID0gbnVsbDsKICAgIH0KCiAgICBhc3luYyBwcmVmZXRjaEZpcnN0QmxvY2sodGltZW91dCkgewogICAgICAvLyBUT0RPOiBpbXBsZW1lbnQgdGltZW91dAoKICAgICAgLy8gR2V0IHRoZSBmaXJzdCBibG9jayBhbmQgY2FjaGUgaXQKICAgICAgbGV0IGJsb2NrID0gYXdhaXQgdGhpcy5nZXQoMCk7CiAgICAgIHRoaXMuY2FjaGVkRmlyc3RCbG9jayA9IGJsb2NrOwogICAgICByZXR1cm4gYmxvY2s7CiAgICB9CgogICAgYXN5bmMgd2FpdENvbXBsZXRlKCkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIC8vIEVhZ2VybHkgY29tbWl0IGl0IGZvciBiZXR0ZXIgcGVyZi4gTm90ZSB0aGF0ICoqdGhpcyBhc3N1bWVzCiAgICAgICAgLy8gdGhlIHRyYW5zYWN0aW9uIGlzIG9wZW4qKiBhcyBgY29tbWl0YCB3aWxsIHRocm93IGFuIGVycm9yIGlmCiAgICAgICAgLy8gaXQncyBhbHJlYWR5IGNsb3NlZCAod2hpY2ggc2hvdWxkIG5ldmVyIGJlIHRoZSBjYXNlIGZvciB1cykKICAgICAgICB0aGlzLmNvbW1pdCgpOwoKICAgICAgICBpZiAodGhpcy5sb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5FWENMVVNJVkUpIHsKICAgICAgICAgIC8vIFdhaXQgdW50aWwgYWxsIHdyaXRlcyBhcmUgY29tbWl0dGVkCiAgICAgICAgICB0aGlzLnRyYW5zLm9uY29tcGxldGUgPSBlID0+IHJlc29sdmUoKTsKCiAgICAgICAgICAvLyBUT0RPOiBJcyBpdCBPSyB0byBhZGQgdGhpcyBsYXRlciwgYWZ0ZXIgYW4gZXJyb3IgbWlnaHQgaGF2ZQogICAgICAgICAgLy8gaGFwcGVuZWQ/IFdpbGwgaXQgaG9sZCB0aGUgZXJyb3IgYW5kIGZpcmUgdGhpcyB3aGVuIHdlCiAgICAgICAgICAvLyBhdHRhY2hlZCBpdD8gV2UgbWlnaHQgd2FudCB0byBlYWdlcmx5IGNyZWF0ZSB0aGUgcHJvbWlzZQogICAgICAgICAgLy8gd2hlbiBjcmVhdGluZyB0aGUgdHJhbnNhY3Rpb24gYW5kIHJldHVybiBpdCBoZXJlCiAgICAgICAgICB0aGlzLnRyYW5zLm9uZXJyb3IgPSBlID0+IHJlamVjdChlKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgaWYgKGlzUHJvYmFibHlTYWZhcmkpIHsKICAgICAgICAgICAgLy8gU2FmYXJpIGhhcyBhIGJ1ZyB3aGVyZSBzb21ldGltZXMgdGhlIElEQiBnZXRzIGJsb2NrZWQKICAgICAgICAgICAgLy8gcGVybWFuZW50bHkgaWYgeW91IHJlZnJlc2ggdGhlIHBhZ2Ugd2l0aCBhbiBvcGVuCiAgICAgICAgICAgIC8vIHRyYW5zYWN0aW9uLiBZb3UgaGF2ZSB0byByZXN0YXJ0IHRoZSBicm93c2VyIHRvIGZpeCBpdC4KICAgICAgICAgICAgLy8gV2Ugd2FpdCBmb3IgcmVhZG9ubHkgdHJhbnNhY3Rpb25zIHRvIGZpbmlzaCB0b28sIGJ1dCB0aGlzCiAgICAgICAgICAgIC8vIGlzIGEgcGVyZiBoaXQKICAgICAgICAgICAgdGhpcy50cmFucy5vbmNvbXBsZXRlID0gZSA9PiByZXNvbHZlKCk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAvLyBObyBuZWVkIHRvIHdhaXQgb24gYW55dGhpbmcgaW4gYSByZWFkLW9ubHkgdHJhbnNhY3Rpb24uCiAgICAgICAgICAgIC8vIE5vdGUgdGhhdCBlcnJvcnMgZHVyaW5nIHJlYWRzIGFyZWEgYWx3YXlzIGhhbmRsZWQgYnkgdGhlCiAgICAgICAgICAgIC8vIHJlYWQgcmVxdWVzdC4KICAgICAgICAgICAgcmVzb2x2ZSgpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSk7CiAgICB9CgogICAgY29tbWl0KCkgewogICAgICAvLyBTYWZhcmkgZG9lc24ndCBzdXBwb3J0IHRoaXMgbWV0aG9kIHlldCAodGhpcyBpcyBqdXN0IGFuCiAgICAgIC8vIG9wdGltaXphdGlvbikKICAgICAgaWYgKHRoaXMudHJhbnMuY29tbWl0KSB7CiAgICAgICAgdGhpcy50cmFucy5jb21taXQoKTsKICAgICAgfQogICAgfQoKICAgIGFzeW5jIHVwZ3JhZGVFeGNsdXNpdmUoKSB7CiAgICAgIHRoaXMuY29tbWl0KCk7CgogICAgICAvLyBjb25zb2xlLmxvZygndXBkYXRpbmcgdHJhbnNhY3Rpb24gcmVhZHdyaXRlJyk7CiAgICAgIGNvdW50KCd0cmFuc2FjdGlvbnMnKTsKICAgICAgdGhpcy50cmFucyA9IHRoaXMuZGIudHJhbnNhY3Rpb24oWydkYXRhJ10sICdyZWFkd3JpdGUnKTsKICAgICAgdGhpcy5zdG9yZSA9IHRoaXMudHJhbnMub2JqZWN0U3RvcmUoJ2RhdGEnKTsKICAgICAgdGhpcy5sb2NrVHlwZSA9IExPQ0tfVFlQRVMuRVhDTFVTSVZFOwoKICAgICAgbGV0IGNhY2hlZDAgPSB0aGlzLmNhY2hlZEZpcnN0QmxvY2s7CgogICAgICAvLyBEbyBhIHJlYWQKICAgICAgbGV0IGJsb2NrID0gYXdhaXQgdGhpcy5wcmVmZXRjaEZpcnN0QmxvY2soNTAwKTsKICAgICAgLy8gVE9ETzogd2hlbiB0aW1lb3V0cyBhcmUgaW1wbGVtZW50ZWQsIGRldGVjdCB0aW1lb3V0IGFuZCByZXR1cm4gQlVTWQoKICAgICAgaWYgKGNhY2hlZDAgPT0gbnVsbCAmJiBibG9jayA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDI0OyBpIDwgNDA7IGkrKykgewogICAgICAgICAgaWYgKGJsb2NrW2ldICE9PSBjYWNoZWQwW2ldKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGRvd25ncmFkZVNoYXJlZCgpIHsKICAgICAgdGhpcy5jb21taXQoKTsKCiAgICAgIC8vIGNvbnNvbGUubG9nKCdkb3duZ3JhZGluZyB0cmFuc2FjdGlvbiByZWFkb25seScpOwogICAgICBjb3VudCgndHJhbnNhY3Rpb25zJyk7CiAgICAgIHRoaXMudHJhbnMgPSB0aGlzLmRiLnRyYW5zYWN0aW9uKFsnZGF0YSddLCAncmVhZG9ubHknKTsKICAgICAgdGhpcy5zdG9yZSA9IHRoaXMudHJhbnMub2JqZWN0U3RvcmUoJ2RhdGEnKTsKICAgICAgdGhpcy5sb2NrVHlwZSA9IExPQ0tfVFlQRVMuU0hBUkVEOwogICAgfQoKICAgIGFzeW5jIGdldChrZXkpIHsKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICByZWNvcmQoJ2dldCcpOwogICAgICAgIGxldCByZXEgPSB0aGlzLnN0b3JlLmdldChrZXkpOwogICAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBlID0+IHsKICAgICAgICAgIGVuZFJlY29yZGluZygnZ2V0Jyk7CiAgICAgICAgICByZXNvbHZlKHJlcS5yZXN1bHQpOwogICAgICAgIH07CiAgICAgICAgcmVxLm9uZXJyb3IgPSBlID0+IHJlamVjdChlKTsKICAgICAgfSk7CiAgICB9CgogICAgZ2V0UmVhZERpcmVjdGlvbigpIHsKICAgICAgLy8gVGhlcmUgYXJlIGEgdHdvIHdheXMgd2UgY2FuIHJlYWQgZGF0YTogYSBkaXJlY3QgYGdldGAgcmVxdWVzdAogICAgICAvLyBvciBvcGVuaW5nIGEgY3Vyc29yIGFuZCBpdGVyYXRpbmcgdGhyb3VnaCBkYXRhLiBXZSBkb24ndCBrbm93CiAgICAgIC8vIHdoYXQgZnV0dXJlIHJlYWRzIGxvb2sgbGlrZSwgc28gd2UgZG9uJ3Qga25vdyB0aGUgYmVzdCBzdHJhdGVneQogICAgICAvLyB0byBwaWNrLiBBbHdheXMgY2hvb3Npbmcgb25lIHN0cmF0ZWd5IGZvcmdvZXMgYSBsb3Qgb2YKICAgICAgLy8gb3B0aW1pemF0aW9uLCBiZWNhdXNlIGl0ZXJhdGluZyB3aXRoIGEgY3Vyc29yIGlzIGEgbG90IGZhc3RlcgogICAgICAvLyB0aGFuIG1hbnkgYGdldGAgY2FsbHMuIE9uIHRoZSBvdGhlciBoYW5kLCBvcGVuaW5nIGEgY3Vyc29yIGlzCiAgICAgIC8vIHNsb3csIGFuZCBzbyBpcyBjYWxsaW5nIGBhZHZhbmNlYCB0byBtb3ZlIGEgY3Vyc29yIG92ZXIgYSBodWdlCiAgICAgIC8vIHJhbmdlIChsaWtlIG1vdmluZyBpdCAxMDAwIGl0ZW1zIGxhdGVyKSwgc28gbWFueSBgZ2V0YCBjYWxscyB3b3VsZAogICAgICAvLyBiZSBmYXN0ZXIuIEluIGdlbmVyYWw6CiAgICAgIC8vCiAgICAgIC8vICogTWFueSBgZ2V0YCBjYWxscyBhcmUgZmFzdGVyIHdoZW4gZG9pbmcgcmFuZG9tIGFjY2Vzc2VzCiAgICAgIC8vICogSXRlcmF0aW5nIHdpdGggYSBjdXJzb3IgaXMgZmFzdGVyIGlmIGRvaW5nIG1vc3RseSBzZXF1ZW50aWFsCiAgICAgIC8vICAgYWNjZXNzZXMKICAgICAgLy8KICAgICAgLy8gV2UgaW1wbGVtZW50IGEgaGV1cmlzdGljIGFuZCBrZWVwcyB0cmFjayBvZiB0aGUgbGFzdCAzIHJlYWRzCiAgICAgIC8vIGFuZCBkZXRlY3RzIHdoZW4gdGhleSBhcmUgbW9zdGx5IHNlcXVlbnRpYWwuIElmIHRoZXkgYXJlLCB3ZQogICAgICAvLyBvcGVuIGEgY3Vyc29yIGFuZCBzdGFydCByZWFkaW5nIGJ5IGl0ZXJhdGluZyBpdC4gSWYgbm90LCB3ZSBkbwogICAgICAvLyBkaXJlY3QgYGdldGAgY2FsbHMuCiAgICAgIC8vCiAgICAgIC8vIE9uIHRvcCBvZiBhbGwgb2YgdGhpcywgZWFjaCBicm93c2VyIGhhcyBkaWZmZXJlbnQgcGVyZgogICAgICAvLyBjaGFyYWN0ZXJpc3RpY3MuIFdlIHdpbGwgcHJvYmFibHkgd2FudCB0byBtYWtlIHRoZXNlIHRocmVzaG9sZHMKICAgICAgLy8gY29uZmlndXJhYmxlIHNvIHRoZSB1c2VyIGNhbiBjaGFuZ2UgdGhlbSBwZXItYnJvd3NlciBpZiBuZWVkZWQsCiAgICAgIC8vIGFzIHdlbGwgYXMgZmluZS10dW5pbmcgdGhlbSBmb3IgdGhlaXIgdXNhZ2Ugb2Ygc3FsaXRlLgoKICAgICAgbGV0IHByZXZSZWFkcyA9IHRoaXMucHJldlJlYWRzOwogICAgICBpZiAocHJldlJlYWRzKSB7CiAgICAgICAgLy8gSGFzIHRoZXJlIGJlZW4gMyBmb3J3YXJkIHNlcXVlbnRpYWwgcmVhZHMgd2l0aGluIDEwIGJsb2Nrcz8KICAgICAgICBpZiAoCiAgICAgICAgICBwcmV2UmVhZHNbMF0gPCBwcmV2UmVhZHNbMV0gJiYKICAgICAgICAgIHByZXZSZWFkc1sxXSA8IHByZXZSZWFkc1syXSAmJgogICAgICAgICAgcHJldlJlYWRzWzJdIC0gcHJldlJlYWRzWzBdIDwgMTAKICAgICAgICApIHsKICAgICAgICAgIHJldHVybiAnbmV4dCc7CiAgICAgICAgfQoKICAgICAgICAvLyBIYXMgdGhlcmUgYmVlbiAzIGJhY2t3YXJkcyBzZXF1ZW50aWFsIHJlYWRzIHdpdGhpbiAxMCBibG9ja3M/CiAgICAgICAgaWYgKAogICAgICAgICAgcHJldlJlYWRzWzBdID4gcHJldlJlYWRzWzFdICYmCiAgICAgICAgICBwcmV2UmVhZHNbMV0gPiBwcmV2UmVhZHNbMl0gJiYKICAgICAgICAgIHByZXZSZWFkc1swXSAtIHByZXZSZWFkc1syXSA8IDEwCiAgICAgICAgKSB7CiAgICAgICAgICByZXR1cm4gJ3ByZXYnOwogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIG51bGw7CiAgICB9CgogICAgcmVhZChwb3NpdGlvbikgewogICAgICBsZXQgd2FpdEN1cnNvciA9ICgpID0+IHsKICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgICAgaWYgKHRoaXMuY3Vyc29yUHJvbWlzZSAhPSBudWxsKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgICAnd2FpdEN1cnNvcigpIGNhbGxlZCBidXQgc29tZXRoaW5nIGVsc2UgaXMgYWxyZWFkeSB3YWl0aW5nJwogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5jdXJzb3JQcm9taXNlID0geyByZXNvbHZlLCByZWplY3QgfTsKICAgICAgICB9KTsKICAgICAgfTsKCiAgICAgIGlmICh0aGlzLmN1cnNvcikgewogICAgICAgIGxldCBjdXJzb3IgPSB0aGlzLmN1cnNvcjsKCiAgICAgICAgaWYgKAogICAgICAgICAgY3Vyc29yLmRpcmVjdGlvbiA9PT0gJ25leHQnICYmCiAgICAgICAgICBwb3NpdGlvbiA+IGN1cnNvci5rZXkgJiYKICAgICAgICAgIHBvc2l0aW9uIDwgY3Vyc29yLmtleSArIDEwMAogICAgICAgICkgewogICAgICAgICAgcmVjb3JkKCdzdHJlYW0tbmV4dCcpOwoKICAgICAgICAgIGN1cnNvci5hZHZhbmNlKHBvc2l0aW9uIC0gY3Vyc29yLmtleSk7CiAgICAgICAgICByZXR1cm4gd2FpdEN1cnNvcigpOwogICAgICAgIH0gZWxzZSBpZiAoCiAgICAgICAgICBjdXJzb3IuZGlyZWN0aW9uID09PSAncHJldicgJiYKICAgICAgICAgIHBvc2l0aW9uIDwgY3Vyc29yLmtleSAmJgogICAgICAgICAgcG9zaXRpb24gPiBjdXJzb3Iua2V5IC0gMTAwCiAgICAgICAgKSB7CiAgICAgICAgICByZWNvcmQoJ3N0cmVhbS1uZXh0Jyk7CgogICAgICAgICAgY3Vyc29yLmFkdmFuY2UoY3Vyc29yLmtleSAtIHBvc2l0aW9uKTsKICAgICAgICAgIHJldHVybiB3YWl0Q3Vyc29yKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIC8vIERpdGNoIHRoZSBjdXJzb3IKICAgICAgICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKICAgICAgICAgIHJldHVybiB0aGlzLnJlYWQocG9zaXRpb24pOwogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBXZSBkb24ndCBhbHJlYWR5IGhhdmUgYSBjdXJzb3IuIFdlIG5lZWQgdG8gYSBmcmVzaCByZWFkOwogICAgICAgIC8vIHNob3VsZCB3ZSBvcGVuIGEgY3Vyc29yIG9yIGNhbGwgYGdldGA/CgogICAgICAgIGxldCBkaXIgPSB0aGlzLmdldFJlYWREaXJlY3Rpb24oKTsKICAgICAgICBpZiAoZGlyKSB7CiAgICAgICAgICAvLyBPcGVuIGEgY3Vyc29yCiAgICAgICAgICB0aGlzLnByZXZSZWFkcyA9IG51bGw7CgogICAgICAgICAgbGV0IGtleVJhbmdlOwogICAgICAgICAgaWYgKGRpciA9PT0gJ3ByZXYnKSB7CiAgICAgICAgICAgIGtleVJhbmdlID0gSURCS2V5UmFuZ2UudXBwZXJCb3VuZChwb3NpdGlvbik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZXlSYW5nZSA9IElEQktleVJhbmdlLmxvd2VyQm91bmQocG9zaXRpb24pOwogICAgICAgICAgfQoKICAgICAgICAgIGxldCByZXEgPSB0aGlzLnN0b3JlLm9wZW5DdXJzb3Ioa2V5UmFuZ2UsIGRpcik7CiAgICAgICAgICByZWNvcmQoJ3N0cmVhbScpOwoKICAgICAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBlID0+IHsKICAgICAgICAgICAgZW5kUmVjb3JkaW5nKCdzdHJlYW0nKTsKICAgICAgICAgICAgZW5kUmVjb3JkaW5nKCdzdHJlYW0tbmV4dCcpOwoKICAgICAgICAgICAgbGV0IGN1cnNvciA9IGUudGFyZ2V0LnJlc3VsdDsKICAgICAgICAgICAgdGhpcy5jdXJzb3IgPSBjdXJzb3I7CgogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3JQcm9taXNlID09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBkYXRhIGZyb20gY3Vyc29yIGJ1dCBub3RoaW5nIGlzIHdhaXRpbmcgaXQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnNvclByb21pc2UucmVzb2x2ZShjdXJzb3IgPyBjdXJzb3IudmFsdWUgOiBudWxsKTsKICAgICAgICAgICAgdGhpcy5jdXJzb3JQcm9taXNlID0gbnVsbDsKICAgICAgICAgIH07CiAgICAgICAgICByZXEub25lcnJvciA9IGUgPT4gewogICAgICAgICAgICBjb25zb2xlLmxvZygnQ3Vyc29yIGZhaWx1cmU6JywgZSk7CgogICAgICAgICAgICBpZiAodGhpcy5jdXJzb3JQcm9taXNlID09IG51bGwpIHsKICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0dvdCBkYXRhIGZyb20gY3Vyc29yIGJ1dCBub3RoaW5nIGlzIHdhaXRpbmcgaXQnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLmN1cnNvclByb21pc2UucmVqZWN0KGUpOwogICAgICAgICAgICB0aGlzLmN1cnNvclByb21pc2UgPSBudWxsOwogICAgICAgICAgfTsKCiAgICAgICAgICByZXR1cm4gd2FpdEN1cnNvcigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAodGhpcy5wcmV2UmVhZHMgPT0gbnVsbCkgewogICAgICAgICAgICB0aGlzLnByZXZSZWFkcyA9IFswLCAwLCAwXTsKICAgICAgICAgIH0KICAgICAgICAgIHRoaXMucHJldlJlYWRzLnB1c2gocG9zaXRpb24pOwogICAgICAgICAgdGhpcy5wcmV2UmVhZHMuc2hpZnQoKTsKCiAgICAgICAgICByZXR1cm4gdGhpcy5nZXQocG9zaXRpb24pOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGFzeW5jIHNldChpdGVtKSB7CiAgICAgIHRoaXMucHJldlJlYWRzID0gbnVsbDsKCiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgbGV0IHJlcSA9IHRoaXMuc3RvcmUucHV0KGl0ZW0udmFsdWUsIGl0ZW0ua2V5KTsKICAgICAgICByZXEub25zdWNjZXNzID0gZSA9PiByZXNvbHZlKHJlcS5yZXN1bHQpOwogICAgICAgIHJlcS5vbmVycm9yID0gZSA9PiByZWplY3QoZSk7CiAgICAgIH0pOwogICAgfQoKICAgIGFzeW5jIGJ1bGtTZXQoaXRlbXMpIHsKICAgICAgdGhpcy5wcmV2UmVhZHMgPSBudWxsOwoKICAgICAgZm9yIChsZXQgaXRlbSBvZiBpdGVtcykgewogICAgICAgIHRoaXMuc3RvcmUucHV0KGl0ZW0udmFsdWUsIGl0ZW0ua2V5KTsKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gbG9hZERiKG5hbWUpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgIGlmIChvcGVuRGJzLmdldChuYW1lKSkgewogICAgICAgIHJlc29sdmUob3BlbkRicy5nZXQobmFtZSkpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgY29uc29sZS5sb2coJ29wZW5pbmcnLCBuYW1lKTsKCiAgICAgIGxldCByZXEgPSBnbG9iYWxUaGlzLmluZGV4ZWREQi5vcGVuKG5hbWUsIDEpOwogICAgICByZXEub25zdWNjZXNzID0gZXZlbnQgPT4gewogICAgICAgIGNvbnNvbGUubG9nKCdkYiBpcyBvcGVuIScsIG5hbWUpOwogICAgICAgIGxldCBkYiA9IGV2ZW50LnRhcmdldC5yZXN1bHQ7CgogICAgICAgIGRiLm9udmVyc2lvbmNoYW5nZSA9ICgpID0+IHsKICAgICAgICAgIC8vIFRPRE86IE5vdGlmeSB0aGUgdXNlciBzb21laG93CiAgICAgICAgICBjb25zb2xlLmxvZygnY2xvc2luZyBiZWNhdXNlIHZlcnNpb24gY2hhbmdlZCcpOwogICAgICAgICAgZGIuY2xvc2UoKTsKICAgICAgICAgIG9wZW5EYnMuZGVsZXRlKG5hbWUpOwogICAgICAgIH07CgogICAgICAgIGRiLm9uY2xvc2UgPSAoKSA9PiB7CiAgICAgICAgICBvcGVuRGJzLmRlbGV0ZShuYW1lKTsKICAgICAgICB9OwoKICAgICAgICBvcGVuRGJzLnNldChuYW1lLCBkYik7CiAgICAgICAgcmVzb2x2ZShkYik7CiAgICAgIH07CiAgICAgIHJlcS5vbnVwZ3JhZGVuZWVkZWQgPSBldmVudCA9PiB7CiAgICAgICAgbGV0IGRiID0gZXZlbnQudGFyZ2V0LnJlc3VsdDsKICAgICAgICBpZiAoIWRiLm9iamVjdFN0b3JlTmFtZXMuY29udGFpbnMoJ2RhdGEnKSkgewogICAgICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUoJ2RhdGEnKTsKICAgICAgICB9CiAgICAgIH07CiAgICAgIHJlcS5vbmJsb2NrZWQgPSBlID0+IGNvbnNvbGUubG9nKCdibG9ja2VkJywgZSk7CiAgICAgIHJlcS5vbmVycm9yID0gcmVxLm9uYWJvcnQgPSBlID0+IHJlamVjdChlLnRhcmdldC5lcnJvcik7CiAgICB9KTsKICB9CgogIGZ1bmN0aW9uIGNsb3NlRGIobmFtZSkgewogICAgbGV0IG9wZW5EYiA9IG9wZW5EYnMuZ2V0KG5hbWUpOwogICAgaWYgKG9wZW5EYikgewogICAgICBjb25zb2xlLmxvZygnY2xvc2luZyBkYicpOwogICAgICBvcGVuRGIuY2xvc2UoKTsKICAgICAgb3BlbkRicy5kZWxldGUobmFtZSk7CiAgICB9CiAgfQoKICBmdW5jdGlvbiBnZXRUcmFuc2FjdGlvbihuYW1lKSB7CiAgICByZXR1cm4gdHJhbnNhY3Rpb25zLmdldChuYW1lKTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIHdpdGhUcmFuc2FjdGlvbihuYW1lLCBtb2RlLCBmdW5jKSB7CiAgICBsZXQgdHJhbnMgPSB0cmFuc2FjdGlvbnMuZ2V0KG5hbWUpOwogICAgaWYgKHRyYW5zKSB7CiAgICAgIC8vIElmIGEgdHJhbnNhY3Rpb24gYWxyZWFkeSBleGlzdHMsIHRoYXQgbWVhbnMgdGhlIGZpbGUgaGFzIGJlZW4KICAgICAgLy8gbG9ja2VkLiBXZSBkb24ndCBmdWxseSBzdXBwb3J0IGFyYml0cmFyeSBuZXN0ZWQgdHJhbnNhY3Rpb25zLAogICAgICAvLyBhcyBzZWVuIGJlbG93ICh3ZSB3b24ndCB1cGdyYWRlIGEgYHJlYWRvbmx5YCB0byBgcmVhZHdyaXRlYAogICAgICAvLyBhdXRvbWF0aWNhbGx5KSBhbmQgdGhpcyBpcyBtYWlubHkgZm9yIHRoZSB1c2UgY2FzZSB3aGVyZSBzcWxpdGUKICAgICAgLy8gbG9ja3MgdGhlIGRiIGFuZCBjcmVhdGVzIGEgdHJhbnNhY3Rpb24gZm9yIHRoZSBkdXJhY3Rpb24gb2YgdGhlCiAgICAgIC8vIGxvY2suIFdlIGRvbid0IGFjdHVhbGx5IHdyaXRlIGNvZGUgaW4gYSB3YXkgdGhhdCBhc3N1bWVzIG5lc3RlZAogICAgICAvLyB0cmFuc2FjdGlvbnMsIHNvIGp1c3QgZXJyb3IgaGVyZQogICAgICBpZiAobW9kZSA9PT0gJ3JlYWR3cml0ZScgJiYgdHJhbnMubG9ja1R5cGUgPT09IExPQ0tfVFlQRVMuU0hBUkVEKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBdHRlbXB0ZWQgd3JpdGUgYnV0IG9ubHkgaGFzIFNIQVJFRCBsb2NrJyk7CiAgICAgIH0KICAgICAgcmV0dXJuIGZ1bmModHJhbnMpOwogICAgfQoKICAgIC8vIE91dHNpZGUgdGhlIHNjb3BlIG9mIGEgbG9jaywgY3JlYXRlIGEgdGVtcG9yYXJ5IHRyYW5zYWN0aW9uCiAgICB0cmFucyA9IG5ldyBUcmFuc2FjdGlvbihhd2FpdCBsb2FkRGIobmFtZSksIG1vZGUpOwogICAgYXdhaXQgZnVuYyh0cmFucyk7CiAgICBhd2FpdCB0cmFucy53YWl0Q29tcGxldGUoKTsKICB9CgogIC8vIExvY2tpbmcgc3RyYXRlZ3k6CiAgLy8KICAvLyAqIFdlIG1hcCBzcWxpdGUncyBsb2NrcyBvbnRvIEluZGV4ZWREQidzIHRyYW5zYWN0aW9uIHNlbWFudGljcy4KICAvLyAgIFJlYWQgdHJhbnNhY3Rpb25zIG1heSBleGVjdXRlIGluIHBhcmFsbGVsLiBSZWFkL3dyaXRlCiAgLy8gICB0cmFuc2FjdGlvbnMgYXJlIHF1ZXVlZCB1cCBhbmQgd2FpdCB1bnRpbCBhbGwgcHJlY2VkaW5nCiAgLy8gICByZWFkIHRyYW5zYWN0aW9ucyBmaW5pc2ggZXhlY3V0aW5nLiBSZWFkIHRyYW5zYWN0aW9ucyBzdGFydGVkCiAgLy8gICBhZnRlciBhIHJlYWQvd3JpdGUgdHJhbnNhY3Rpb24gd2FpdCB1bnRpbCBpdCBpcyBmaW5pc2hlZC4KICAvLwogIC8vICogSURCIHRyYW5zYWN0aW9ucyB3aWxsIHdhaXQgZm9yZXZlciB1bnRpbCB0aGV5IGNhbiBleGVjdXRlIChmb3IKICAvLyAgIGV4YW1wbGUsIHRoZXkgbWF5IGJlIGJsb2NrZWQgb24gYSByZWFkL3dyaXRlIHRyYW5zYWN0aW9uKS4gV2UKICAvLyAgIGRvbid0IHdhbnQgdG8gYWxsb3cgc3FsaXRlIHRyYW5zYWN0aW9ucyB0byB3YWl0IGZvcmV2ZXIsIHNvCiAgLy8gICB3ZSBtYW51YWxseSB0aW1lb3V0IGlmIGEgdHJhbnNhY3Rpb24gdGFrZXMgdG9vIGxvbmcgdG8KICAvLyAgIHN0YXJ0IGV4ZWN1dGluZy4gVGhpcyBzaW11bGF0ZXMgdGhlIGJlaGF2aW9yIG9mIGEgc3FsaXRlCiAgLy8gICBiYWlsaW5nIGlmIGl0IGNhbid0IHJlcXVpcmUgYSBsb2NrLgogIC8vCiAgLy8gKiBBIFNIQVJFRCBsb2NrIHdhbnRzIHRvIHJlYWQgZnJvbSB0aGUgZGIuIFdlIHN0YXJ0IGEgcmVhZAogIC8vICAgdHJhbnNhY3Rpb24gYW5kIHJlYWQgdGhlIGZpcnN0IGJsb2NrLCBhbmQgaWYgd2UgcmVhZCBpdCB3aXRoaW4KICAvLyAgIDUwMG1zIHdlIGNvbnNpZGVyIHRoZSBsb2NrIHN1Y2Nlc3NmdWwuIE90aGVyd2lzZSB0aGUgbG9jawogIC8vICAgZmFpbGVkIGFuZCB3ZSByZXR1cm4gU1FMSVRFX0JVU1kuIChUaGVyZSdzIG5vIHBlcmYgZG93bnNpZGUKICAvLyAgIHRvIHJlYWRpbmcgdGhlIGZpcnN0IGJsb2NrIC0gaXQgaGFzIHRvIGJlIHJlYWQgYW55d2F5IHRvIGNoZWNrCiAgLy8gICBieXRlcyAyNC0zOSBmb3IgdGhlIGNoYW5nZSBjb3VudGVyKQogIC8vCiAgLy8gKiBBIFJFU0VSVkVEIGxvY2sgbWVhbnMgdGhlIGRiIHdhbnRzIHRvIHN0YXJ0IHdyaXRpbmcgKHRoaW5rIG9mCiAgLy8gICBgQkVHSU4gVFJBTlNBQ1RJT05gKS4gT25seSBvbmUgcHJvY2VzcyBjYW4gb2J0YWluIGEgUkVTRVJWRUQKICAvLyAgIGxvY2sgYXQgYSB0aW1lLCBidXQgbm9ybWFsbHkgc3FsaXRlIHN0aWxsIGxlYWRzIG5ldyByZWFkIGxvY2tzCiAgLy8gICBoYXBwZW4uIEl0IGlzbid0IHVudGlsIGFuIEVYQ0xVU0lWRSBsb2NrIGlzIGhlbGQgdGhhdCByZWFkcyBhcmUKICAvLyAgIGJsb2NrZWQuIEhvd2V2ZXIsIHNpbmNlIHdlIG5lZWQgdG8gZ3VhcmFudGVlIG9ubHkgb25lIFJFU0VSVkVECiAgLy8gICBsb2NrIGF0IG9uY2UgKG90aGVyd2lzZSBkYXRhIGNvdWxkIGNoYW5nZSBmcm9tIGFub3RoZXIgcHJvY2VzcwogIC8vICAgd2l0aGluIGEgdHJhbnNhY3Rpb24sIGNhdXNpbmcgZmF1bHR5IGNhY2hlcyBldGMpIHRoZSBzaW1wbGVzdAogIC8vICAgdGhpbmcgdG8gZG8gaXMgZ28gYWhlYWQgYW5kIGdyYWIgYSByZWFkL3dyaXRlIHRyYW5zYWN0aW9uIHRoYXQKICAvLyAgIHJlcHJlc2VudHMgdGhlIFJFU0VSVkVEIGxvY2suIFRoaXMgd2lsbCBibG9jayBhbGwgcmVhZHMgZnJvbQogIC8vICAgaGFwcGVuaW5nLCBhbmQgaXMgZXNzZW50aWFsbHkgdGhlIHNhbWUgYXMgYW4gRVhDTFVTSVZFIGxvY2suCiAgLy8KICAvLyAgICAgKiBUaGUgbWFpbiBwcm9ibGVtIGhlcmUgaXMgd2UgY2FuJ3QgInVwZ3JhZGUiIGEgYHJlYWRvbmx5YAogIC8vICAgICAgIHRyYW5zYWN0aW9uIHRvIGByZWFkd3JpdGVgLCBidXQgbmF0aXZlIHNxbGl0ZSBjYW4gdXBncmFkZSBhCiAgLy8gICAgICAgbG9jayBmcm9tIFNIQVJFRCB0byBSRVNFUlZFRC4gV2UgbmVlZCB0byBzdGFydCBhIG5ldwogIC8vICAgICAgIHRyYW5zYWN0aW9uIHRvIGRvIHNvLCBhbmQgYmVjYXVzZSBvZiB0aGF0IHRoZXJlIG1pZ2h0IGJlCiAgLy8gICAgICAgb3RoZXIgYHJlYWR3cml0ZWAgdHJhbnNhY3Rpb25zIHRoYXQgZ2V0IHJ1biBkdXJpbmcgdGhlCiAgLy8gICAgICAgInVwZ3JhZGUiIHdoaWNoIGludmFsaWRhdGVzIHRoZSB3aG9sZSBsb2NraW5nIHByb2Nlc3MgYW5kCiAgLy8gICAgICAgYW5kIGNvcnJ1cHRzIGRhdGEuCiAgLy8KICAvLyAqIElkZWFsbHksIHdlIGNvdWxkIHRlbGwgc3FsaXRlIHRvIHNraXAgU0hBUkVEIGxvY2tzIGVudGlyZWx5LiBXZQogIC8vICAgZG9uJ3QgbmVlZCB0aGVtIHNpbmNlIHdlIGNhbiByZWx5IG9uIEluZGV4ZWREQidzIHNlbWFudGljcy4KICAvLyAgIFRoZW4gd2hlbiBpdCB3YW50cyB0byBzdGFydCB3cml0aW5nLCB3ZSBnZXQgYSBSRVNFUlZFRCBsb2NrCiAgLy8gICB3aXRob3V0IGhhdmluZyB0byB1cGdyYWRlIGZyb20gU0hBUkVELiBUaGlzIHdvdWxkIHNhdmUgdXMKICAvLyAgIHRoZSBjb3N0IG9mIGEgYHJlYWRvbmx5YCB0cmFuc2FjdGlvbiB3aGVuIHdyaXRpbmc7IHJpZ2h0IG5vdwogIC8vICAgaXQgbXVzdCBvcGVuIGEgYHJlYWRvbmx5YCB0cmFuc2FjdGlvbiBhbmQgdGhlbiBpbW1lZGlhdGVseSBvcGVuCiAgLy8gICBhIGByZWFkd3JpdGVgIHRvIHVwZ3JhZGUgaXQuIEkgdGhvdWdodCBvZiBkZWZlcnJpbmcgb3BlbmluZyB0aGUKICAvLyAgIGByZWFkb25seWAgdHJhbnNhY3Rpb24gdW50aWwgc29tZXRoaW5nIGlzIGFjdHVhbGx5IHJlYWQsIGJ1dAogIC8vICAgdW5mb3J0dW5hdGVseSBzcWxpdGUgb3BlbnMgaXQsIHJlYWRzIHRoZSBmaXJzdCBibG9jaywgYW5kIHRoZW4KICAvLyAgIHVwZ3JhZGVzIGl0LiBTbyB0aGVyZSdzIG5vIHdheSBhcm91bmQgaXQuIChXZSBjYW4ndCBhc3N1bWUgaXQncwogIC8vICAgYSBgcmVhZHdyaXRlYCB0cmFuc2FjdGlvbiBhdCB0aGF0IHBvaW50IHNpbmNlIHRoYXQgd291bGQgYXNzdW1lCiAgLy8gICBhbGwgU0hBUkVEIGxvY2tzIGFyZSBgcmVhZHdyaXRlYCwgcmVtb3ZpbmcgdGhlIHBvc3NpYmlsaXR5IG9mCiAgLy8gICBjb25jdXJyZW50IHJlYWRzKS4KICAvLwogIC8vICogVXBncmFkaW5nIHRvIGFuIEVYQ0xVU0lWRSBsb2NrIGlzIGEgbm9vcCwgc2luY2Ugd2UgdHJlYXQgUkVTRVJWRUQKICAvLyAgIGxvY2tzIGFzIEVYQ0xVU0lWRS4KICBhc3luYyBmdW5jdGlvbiBoYW5kbGVMb2NrKHdyaXRlciwgbmFtZSwgbG9ja1R5cGUpIHsKICAgIC8vIGNvbnNvbGUubG9nKCdsb2NraW5nJywgbmFtZSwgbG9ja1R5cGUsIHBlcmZvcm1hbmNlLm5vdygpKTsKCiAgICBsZXQgdHJhbnMgPSB0cmFuc2FjdGlvbnMuZ2V0KG5hbWUpOwogICAgaWYgKHRyYW5zKSB7CiAgICAgIGlmIChsb2NrVHlwZSA+IHRyYW5zLmxvY2tUeXBlKSB7CiAgICAgICAgLy8gVXBncmFkZSBTSEFSRUQgdG8gRVhDTFVTSVZFCiAgICAgICAgYXNzZXJ0KAogICAgICAgICAgdHJhbnMubG9ja1R5cGUgPT09IExPQ0tfVFlQRVMuU0hBUkVELAogICAgICAgICAgYFVwcmFkaW5nIGxvY2sgdHlwZSBmcm9tICR7dHJhbnMubG9ja1R5cGV9IGlzIGludmFsaWRgCiAgICAgICAgKTsKICAgICAgICBhc3NlcnQoCiAgICAgICAgICBsb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5SRVNFUlZFRCB8fCBsb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5FWENMVVNJVkUsCiAgICAgICAgICBgVXBncmFkaW5nIGxvY2sgdHlwZSB0byAke2xvY2tUeXBlfSBpcyBpbnZhbGlkYAogICAgICAgICk7CgogICAgICAgIGxldCBzdWNjZXNzID0gYXdhaXQgdHJhbnMudXBncmFkZUV4Y2x1c2l2ZSgpOwogICAgICAgIHdyaXRlci5pbnQzMihzdWNjZXNzID8gMCA6IC0xKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBJZiBub3QgdXBncmFkaW5nIGFuZCB3ZSBhbHJlYWR5IGhhdmUgYSBsb2NrLCBtYWtlIHN1cmUgdGhpcwogICAgICAgIC8vIGlzbid0IGEgZG93bmdyYWRlCiAgICAgICAgYXNzZXJ0KAogICAgICAgICAgdHJhbnMubG9ja1R5cGUgPT09IGxvY2tUeXBlLAogICAgICAgICAgYERvd25ncmFkaW5nIGxvY2sgdG8gJHtsb2NrVHlwZX0gaXMgaW52YWxpZGAKICAgICAgICApOwoKICAgICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGFzc2VydCgKICAgICAgICBsb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5TSEFSRUQsCiAgICAgICAgYE5ldyBsb2NrcyBtdXN0IHN0YXJ0IGFzIFNIQVJFRCBpbnN0ZWFkIG9mICR7bG9ja1R5cGV9YAogICAgICApOwoKICAgICAgbGV0IHRyYW5zID0gbmV3IFRyYW5zYWN0aW9uKGF3YWl0IGxvYWREYihuYW1lKSk7CiAgICAgIGlmICgoYXdhaXQgdHJhbnMucHJlZmV0Y2hGaXJzdEJsb2NrKDUwMCkpID09IG51bGwpIDsKCiAgICAgIHRyYW5zYWN0aW9ucy5zZXQobmFtZSwgdHJhbnMpOwoKICAgICAgd3JpdGVyLmludDMyKDApOwogICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgIH0KICB9CgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVVubG9jayh3cml0ZXIsIG5hbWUsIGxvY2tUeXBlKSB7CiAgICAvLyBjb25zb2xlLmxvZygndW5sb2NraW5nJywgbmFtZSwgbG9ja1R5cGUsIHBlcmZvcm1hbmNlLm5vdygpKTsKCiAgICBsZXQgdHJhbnMgPSBnZXRUcmFuc2FjdGlvbihuYW1lKTsKCiAgICBpZiAobG9ja1R5cGUgPT09IExPQ0tfVFlQRVMuU0hBUkVEKSB7CiAgICAgIGlmICh0cmFucyA9PSBudWxsKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdVbmxvY2sgZXJyb3IgKFNIQVJFRCk6IG5vIHRyYW5zYWN0aW9uIHJ1bm5pbmcnKTsKICAgICAgfQoKICAgICAgaWYgKHRyYW5zLmxvY2tUeXBlID09PSBMT0NLX1RZUEVTLkVYQ0xVU0lWRSkgewogICAgICAgIHRyYW5zLmRvd25ncmFkZVNoYXJlZCgpOwogICAgICB9CiAgICB9IGVsc2UgaWYgKGxvY2tUeXBlID09PSBMT0NLX1RZUEVTLk5PTkUpIHsKICAgICAgLy8gSSB0aG91Z2h0IHdlIGNvdWxkIGFzc3VtZSBhIGxvY2sgaXMgYWx3YXlzIG9wZW4gd2hlbiBgdW5sb2NrYAogICAgICAvLyBpcyBjYWxsZWQsIGJ1dCBpdCBhbHNvIGNhbGxzIGB1bmxvY2tgIHdoZW4gY2xvc2luZyB0aGUgZmlsZSBubwogICAgICAvLyBtYXR0ZXIgd2hhdC4gRG8gbm90aGluZyBpZiB0aGVyZSdzIG5vIGxvY2sgY3VycmVudGx5CiAgICAgIGlmICh0cmFucykgewogICAgICAgIC8vIFRPRE86IHRoaXMgaXMgd2hlcmUgYW4gZXJyb3IgY291bGQgYnViYmxlIHVwLiBIYW5kbGUgaXQKICAgICAgICBhd2FpdCB0cmFucy53YWl0Q29tcGxldGUoKTsKICAgICAgICB0cmFuc2FjdGlvbnMuZGVsZXRlKG5hbWUpOwogICAgICB9CiAgICB9CgogICAgd3JpdGVyLmludDMyKDApOwogICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBoYW5kbGVSZWFkKHdyaXRlciwgbmFtZSwgcG9zaXRpb24pIHsKICAgIHJldHVybiB3aXRoVHJhbnNhY3Rpb24obmFtZSwgJ3JlYWRvbmx5JywgYXN5bmMgdHJhbnMgPT4gewogICAgICBsZXQgZGF0YSA9IGF3YWl0IHRyYW5zLnJlYWQocG9zaXRpb24pOwoKICAgICAgaWYgKGRhdGEgPT0gbnVsbCkgewogICAgICAgIHdyaXRlci5ieXRlcyhuZXcgQXJyYXlCdWZmZXIoMCkpOwogICAgICB9IGVsc2UgewogICAgICAgIHdyaXRlci5ieXRlcyhkYXRhKTsKICAgICAgfQogICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgIH0pOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlV3JpdGVzKHdyaXRlciwgbmFtZSwgd3JpdGVzKSB7CiAgICByZXR1cm4gd2l0aFRyYW5zYWN0aW9uKG5hbWUsICdyZWFkd3JpdGUnLCBhc3luYyB0cmFucyA9PiB7CiAgICAgIGF3YWl0IHRyYW5zLmJ1bGtTZXQod3JpdGVzLm1hcCh3ID0+ICh7IGtleTogdy5wb3MsIHZhbHVlOiB3LmRhdGEgfSkpKTsKCiAgICAgIHdyaXRlci5pbnQzMigwKTsKICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICB9KTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJlYWRNZXRhKHdyaXRlciwgbmFtZSkgewogICAgcmV0dXJuIHdpdGhUcmFuc2FjdGlvbihuYW1lLCAncmVhZG9ubHknLCBhc3luYyB0cmFucyA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgY29uc29sZS5sb2coJ1JlYWRpbmcgbWV0YScpOwogICAgICAgIGxldCByZXMgPSBhd2FpdCB0cmFucy5nZXQoLTEpOwogICAgICAgIGNvbnNvbGUubG9nKCdSZWFkaW5nIG1ldGEgKGRvbmUpJywgcmVzKTsKCiAgICAgICAgbGV0IG1ldGEgPSByZXM7CiAgICAgICAgd3JpdGVyLmludDMyKG1ldGEgPyBtZXRhLnNpemUgOiAtMSk7CiAgICAgICAgd3JpdGVyLmludDMyKG1ldGEgPyBtZXRhLmJsb2NrU2l6ZSA6IC0xKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgY29uc29sZS5sb2coZXJyKTsKICAgICAgICB3cml0ZXIuaW50MzIoLTEpOwogICAgICAgIHdyaXRlci5pbnQzMigtMSk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgIH0KICAgIH0pOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlV3JpdGVNZXRhKHdyaXRlciwgbmFtZSwgbWV0YSkgewogICAgcmV0dXJuIHdpdGhUcmFuc2FjdGlvbihuYW1lLCAncmVhZHdyaXRlJywgYXN5bmMgdHJhbnMgPT4gewogICAgICB0cnkgewogICAgICAgIGF3YWl0IHRyYW5zLnNldCh7IGtleTogLTEsIHZhbHVlOiBtZXRhIH0pOwoKICAgICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnNvbGUubG9nKGVycik7CiAgICAgICAgd3JpdGVyLmludDMyKC0xKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBoYW5kbGVEZWxldGVGaWxlKHdyaXRlciwgbmFtZSkgewogICAgdHJ5IHsKICAgICAgY2xvc2VEYihuYW1lKTsKCiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBsZXQgcmVxID0gZ2xvYmFsVGhpcy5pbmRleGVkREIuZGVsZXRlRGF0YWJhc2UobmFtZSk7CiAgICAgICAgcmVxLm9uc3VjY2VzcyA9IHJlc29sdmU7CiAgICAgICAgcmVxLm9uZXJyb3IgPSByZWplY3Q7CiAgICAgIH0pOwoKICAgICAgd3JpdGVyLmludDMyKDApOwogICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgIH0gY2F0Y2ggKGVycikgewogICAgICB3cml0ZXIuaW50MzIoLTEpOwogICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgIH0KICB9CgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZUNsb3NlRmlsZSh3cml0ZXIsIG5hbWUpIHsKICAgIGNsb3NlRGIobmFtZSk7CgogICAgd3JpdGVyLmludDMyKDApOwogICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgfQoKICAvLyBgbGlzdGVuYCBjb250aW51YWxseSBsaXN0ZW5zIGZvciByZXF1ZXN0cyB2aWEgdGhlIHNoYXJlZCBidWZmZXIuCiAgLy8gUmlnaHQgbm93IGl0J3MgaW1wbGVtZW50ZWQgaW4gYSB0YWlsLWNhbGwgc3R5bGUgKGBsaXN0ZW5gIGlzCiAgLy8gcmVjdXJzaXZlbHkgY2FsbGVkKSBiZWNhdXNlIEkgdGhvdWdodCB0aGF0IHdhcyBuZWNlc3NhcnkgZm9yCiAgLy8gdmFyaW91cyByZWFzb25zLiBXZSBjYW4gY29udmVydCB0aGlzIHRvIGEgYHdoaWxlKDEpYCBsb29wIHdpdGgKICAvLyBhbmQgdXNlIGBhd2FpdGAgdGhvdWdoCiAgYXN5bmMgZnVuY3Rpb24gbGlzdGVuKHJlYWRlciwgd3JpdGVyKSB7CiAgICBsZXQgbWV0aG9kID0gcmVhZGVyLnN0cmluZygpOwoKICAgIHN3aXRjaCAobWV0aG9kKSB7CiAgICAgIGNhc2UgJ3Byb2ZpbGUtc3RhcnQnOiB7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKCiAgICAgICAgc3RhcnQoKTsKCiAgICAgICAgd3JpdGVyLmludDMyKDApOwogICAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgICAgIGxpc3RlbihyZWFkZXIsIHdyaXRlcik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGNhc2UgJ3Byb2ZpbGUtc3RvcCc6IHsKICAgICAgICByZWFkZXIuZG9uZSgpOwoKICAgICAgICBzdG9wKCk7CiAgICAgICAgLy8gVGhlIHBlcmYgbGlicmFyeSBwb3N0cyBhIG1lc3NhZ2U7IG1ha2Ugc3VyZSBpdCBoYXMgdGltZSB0bwogICAgICAgIC8vIGFjdHVhbGx5IHBvc3QgaXQgYmVmb3JlIGJsb2NraW5nIHRoZSB0aHJlYWQgYWdhaW4KICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOwoKICAgICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgICAgbGlzdGVuKHJlYWRlciwgd3JpdGVyKTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY2FzZSAnd3JpdGVCbG9ja3MnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHdyaXRlcyA9IFtdOwogICAgICAgIHdoaWxlICghcmVhZGVyLmRvbmUoKSkgewogICAgICAgICAgbGV0IHBvcyA9IHJlYWRlci5pbnQzMigpOwogICAgICAgICAgbGV0IGRhdGEgPSByZWFkZXIuYnl0ZXMoKTsKICAgICAgICAgIHdyaXRlcy5wdXNoKHsgcG9zLCBkYXRhIH0pOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgaGFuZGxlV3JpdGVzKHdyaXRlciwgbmFtZSwgd3JpdGVzKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdyZWFkQmxvY2snOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHBvcyA9IHJlYWRlci5pbnQzMigpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZVJlYWQod3JpdGVyLCBuYW1lLCBwb3MpOwogICAgICAgIGxpc3RlbihyZWFkZXIsIHdyaXRlcik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGNhc2UgJ3JlYWRNZXRhJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIHJlYWRlci5kb25lKCk7CiAgICAgICAgYXdhaXQgaGFuZGxlUmVhZE1ldGEod3JpdGVyLCBuYW1lKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICd3cml0ZU1ldGEnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHNpemUgPSByZWFkZXIuaW50MzIoKTsKICAgICAgICBsZXQgYmxvY2tTaXplID0gcmVhZGVyLmludDMyKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKICAgICAgICBhd2FpdCBoYW5kbGVXcml0ZU1ldGEod3JpdGVyLCBuYW1lLCB7IHNpemUsIGJsb2NrU2l6ZSB9KTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdkZWxldGVGaWxlJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZURlbGV0ZUZpbGUod3JpdGVyLCBuYW1lKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdjbG9zZUZpbGUnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKCiAgICAgICAgYXdhaXQgaGFuZGxlQ2xvc2VGaWxlKHdyaXRlciwgbmFtZSk7CiAgICAgICAgbGlzdGVuKHJlYWRlciwgd3JpdGVyKTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY2FzZSAnbG9ja0ZpbGUnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IGxvY2tUeXBlID0gcmVhZGVyLmludDMyKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKCiAgICAgICAgYXdhaXQgaGFuZGxlTG9jayh3cml0ZXIsIG5hbWUsIGxvY2tUeXBlKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICd1bmxvY2tGaWxlJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIGxldCBsb2NrVHlwZSA9IHJlYWRlci5pbnQzMigpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZVVubG9jayh3cml0ZXIsIG5hbWUsIGxvY2tUeXBlKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBtZXRob2Q6ICcgKyBtZXRob2QpOwogICAgfQogIH0KCiAgc2VsZi5vbm1lc3NhZ2UgPSBtc2cgPT4gewogICAgc3dpdGNoIChtc2cuZGF0YS50eXBlKSB7CiAgICAgIGNhc2UgJ2luaXQnOiB7CiAgICAgICAgcG9zdE1lc3NhZ2UoeyB0eXBlOiAnX19hYnN1cmQ6d29ya2VyLXJlYWR5JyB9KTsKICAgICAgICBsZXQgW2FyZ0J1ZmZlciwgcmVzdWx0QnVmZmVyXSA9IG1zZy5kYXRhLmJ1ZmZlcnM7CiAgICAgICAgbGV0IHJlYWRlciA9IG5ldyBSZWFkZXIoYXJnQnVmZmVyLCB7IG5hbWU6ICdhcmdzJywgZGVidWc6IGZhbHNlIH0pOwogICAgICAgIGxldCB3cml0ZXIgPSBuZXcgV3JpdGVyKHJlc3VsdEJ1ZmZlciwgeyBuYW1lOiAncmVzdWx0cycsIGRlYnVnOiBmYWxzZSB9KTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfTsKCn0oKSk7Cgo=', null, false);
/* eslint-enable */

export default WorkerFactory;
