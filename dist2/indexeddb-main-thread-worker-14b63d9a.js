function decodeBase64(base64, enableUnicode) {
    var binaryString = atob(base64);
    if (enableUnicode) {
        var binaryView = new Uint8Array(binaryString.length);
        for (var i = 0, n = binaryString.length; i < n; ++i) {
            binaryView[i] = binaryString.charCodeAt(i);
        }
        return String.fromCharCode.apply(null, new Uint16Array(binaryView.buffer));
    }
    return binaryString;
}

function createURL(base64, sourcemapArg, enableUnicodeArg) {
    var sourcemap = sourcemapArg === undefined ? null : sourcemapArg;
    var enableUnicode = enableUnicodeArg === undefined ? false : enableUnicodeArg;
    var source = decodeBase64(base64, enableUnicode);
    var start = source.indexOf('\n', 10) + 1;
    var body = source.substring(start) + (sourcemap ? '\/\/# sourceMappingURL=' + sourcemap : '');
    var blob = new Blob([body], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

function createBase64WorkerFactory(base64, sourcemapArg, enableUnicodeArg) {
    var url;
    return function WorkerFactory(options) {
        url = url || createURL(base64, sourcemapArg, enableUnicodeArg);
        return new Worker(url, options);
    };
}

var WorkerFactory = createBase64WorkerFactory('Lyogcm9sbHVwLXBsdWdpbi13ZWItd29ya2VyLWxvYWRlciAqLwooZnVuY3Rpb24gKCkgewogICd1c2Ugc3RyaWN0JzsKCiAgbGV0IEZJTkFMSVpFRCA9IDB4ZGVhZGJlZWY7CgogIGxldCBXUklURUFCTEUgPSAwOwogIGxldCBSRUFEQUJMRSA9IDE7CgogIGNsYXNzIFJlYWRlciB7CiAgICBjb25zdHJ1Y3RvcigKICAgICAgYnVmZmVyLAogICAgICB7IGluaXRpYWxPZmZzZXQgPSA0LCB1c2VBdG9taWNzID0gdHJ1ZSwgc3RyZWFtID0gdHJ1ZSwgZGVidWcsIG5hbWUgfSA9IHt9CiAgICApIHsKICAgICAgdGhpcy5idWZmZXIgPSBidWZmZXI7CiAgICAgIHRoaXMuYXRvbWljVmlldyA9IG5ldyBJbnQzMkFycmF5KGJ1ZmZlcik7CiAgICAgIHRoaXMub2Zmc2V0ID0gaW5pdGlhbE9mZnNldDsKICAgICAgdGhpcy51c2VBdG9taWNzID0gdXNlQXRvbWljczsKICAgICAgdGhpcy5zdHJlYW0gPSBzdHJlYW07CiAgICAgIHRoaXMuZGVidWcgPSBkZWJ1ZzsKICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgIH0KCiAgICBsb2coLi4uYXJncykgewogICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbcmVhZGVyOiAke3RoaXMubmFtZX1dYCwgLi4uYXJncyk7CiAgICAgIH0KICAgIH0KCiAgICB3YWl0V3JpdGUobmFtZSkgewogICAgICBpZiAodGhpcy51c2VBdG9taWNzKSB7CiAgICAgICAgdGhpcy5sb2coYHdhaXRpbmcgZm9yICR7bmFtZX1gKTsKCiAgICAgICAgd2hpbGUgKEF0b21pY3MubG9hZCh0aGlzLmF0b21pY1ZpZXcsIDApID09PSBXUklURUFCTEUpIHsKICAgICAgICAgIC8vIGNvbnNvbGUubG9nKCd3YWl0aW5nIGZvciB3cml0ZS4uLicpOwogICAgICAgICAgQXRvbWljcy53YWl0KHRoaXMuYXRvbWljVmlldywgMCwgV1JJVEVBQkxFLCA1MDApOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5sb2coYHJlc3VtZWQgZm9yICR7bmFtZX1gKTsKICAgICAgfSBlbHNlIHsKICAgICAgICBpZiAodGhpcy5hdG9taWNWaWV3WzBdICE9PSBSRUFEQUJMRSkgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdgd2FpdFdyaXRlYCBleHBlY3RlZCBhcnJheSB0byBiZSByZWFkYWJsZScpOwogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGZsaXAoKSB7CiAgICAgIHRoaXMubG9nKCdmbGlwJyk7CiAgICAgIGlmICh0aGlzLnVzZUF0b21pY3MpIHsKICAgICAgICBsZXQgcHJldiA9IEF0b21pY3MuY29tcGFyZUV4Y2hhbmdlKAogICAgICAgICAgdGhpcy5hdG9taWNWaWV3LAogICAgICAgICAgMCwKICAgICAgICAgIFJFQURBQkxFLAogICAgICAgICAgV1JJVEVBQkxFCiAgICAgICAgKTsKCiAgICAgICAgaWYgKHByZXYgIT09IFJFQURBQkxFKSB7CiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlYWQgZGF0YSBvdXQgb2Ygc3luYyEgVGhpcyBpcyBkaXNhc3Ryb3VzJyk7CiAgICAgICAgfQoKICAgICAgICBBdG9taWNzLm5vdGlmeSh0aGlzLmF0b21pY1ZpZXcsIDApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXRvbWljVmlld1swXSA9IFdSSVRFQUJMRTsKICAgICAgfQoKICAgICAgdGhpcy5vZmZzZXQgPSA0OwogICAgfQoKICAgIGRvbmUoKSB7CiAgICAgIHRoaXMud2FpdFdyaXRlKCdkb25lJyk7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KTsKICAgICAgbGV0IGRvbmUgPSBkYXRhVmlldy5nZXRVaW50MzIoMCkgPT09IEZJTkFMSVpFRDsKCiAgICAgIGlmIChkb25lKSB7CiAgICAgICAgdGhpcy5sb2coJ2RvbmUnKTsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGRvbmU7CiAgICB9CgogICAgcGVlayhmbikgewogICAgICB0aGlzLnBlZWtPZmZzZXQgPSB0aGlzLm9mZnNldDsKICAgICAgbGV0IHJlcyA9IGZuKCk7CiAgICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5wZWVrT2Zmc2V0OwogICAgICB0aGlzLnBlZWtPZmZzZXQgPSBudWxsOwogICAgICByZXR1cm4gcmVzOwogICAgfQoKICAgIHN0cmluZygpIHsKICAgICAgdGhpcy53YWl0V3JpdGUoJ3N0cmluZycpOwoKICAgICAgbGV0IGJ5dGVMZW5ndGggPSB0aGlzLl9pbnQzMigpOwogICAgICBsZXQgbGVuZ3RoID0gYnl0ZUxlbmd0aCAvIDI7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgbGV0IGNoYXJzID0gW107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsKICAgICAgICBjaGFycy5wdXNoKGRhdGFWaWV3LmdldFVpbnQxNihpICogMikpOwogICAgICB9CiAgICAgIGxldCBzdHIgPSBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5KG51bGwsIGNoYXJzKTsKICAgICAgdGhpcy5sb2coJ3N0cmluZycsIHN0cik7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwoKICAgICAgaWYgKHRoaXMucGVla09mZnNldCA9PSBudWxsKSB7CiAgICAgICAgdGhpcy5mbGlwKCk7CiAgICAgIH0KICAgICAgcmV0dXJuIHN0cjsKICAgIH0KCiAgICBfaW50MzIoKSB7CiAgICAgIGxldCBieXRlTGVuZ3RoID0gNDsKCiAgICAgIGxldCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQpOwogICAgICBsZXQgbnVtID0gZGF0YVZpZXcuZ2V0SW50MzIoKTsKICAgICAgdGhpcy5sb2coJ19pbnQzMicsIG51bSk7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwogICAgICByZXR1cm4gbnVtOwogICAgfQoKICAgIGludDMyKCkgewogICAgICB0aGlzLndhaXRXcml0ZSgnaW50MzInKTsKICAgICAgbGV0IG51bSA9IHRoaXMuX2ludDMyKCk7CiAgICAgIHRoaXMubG9nKCdpbnQzMicsIG51bSk7CgogICAgICBpZiAodGhpcy5wZWVrT2Zmc2V0ID09IG51bGwpIHsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQogICAgICByZXR1cm4gbnVtOwogICAgfQoKICAgIGJ5dGVzKCkgewogICAgICB0aGlzLndhaXRXcml0ZSgnYnl0ZXMnKTsKCiAgICAgIGxldCBieXRlTGVuZ3RoID0gdGhpcy5faW50MzIoKTsKCiAgICAgIGxldCBieXRlcyA9IG5ldyBBcnJheUJ1ZmZlcihieXRlTGVuZ3RoKTsKICAgICAgbmV3IFVpbnQ4QXJyYXkoYnl0ZXMpLnNldCgKICAgICAgICBuZXcgVWludDhBcnJheSh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQsIGJ5dGVMZW5ndGgpCiAgICAgICk7CiAgICAgIHRoaXMubG9nKCdieXRlcycsIGJ5dGVzKTsKCiAgICAgIHRoaXMub2Zmc2V0ICs9IGJ5dGVMZW5ndGg7CgogICAgICBpZiAodGhpcy5wZWVrT2Zmc2V0ID09IG51bGwpIHsKICAgICAgICB0aGlzLmZsaXAoKTsKICAgICAgfQogICAgICByZXR1cm4gYnl0ZXM7CiAgICB9CiAgfQoKICBjbGFzcyBXcml0ZXIgewogICAgY29uc3RydWN0b3IoCiAgICAgIGJ1ZmZlciwKICAgICAgeyBpbml0aWFsT2Zmc2V0ID0gNCwgdXNlQXRvbWljcyA9IHRydWUsIHN0cmVhbSA9IHRydWUsIGRlYnVnLCBuYW1lIH0gPSB7fQogICAgKSB7CiAgICAgIHRoaXMuYnVmZmVyID0gYnVmZmVyOwogICAgICB0aGlzLmF0b21pY1ZpZXcgPSBuZXcgSW50MzJBcnJheShidWZmZXIpOwogICAgICB0aGlzLm9mZnNldCA9IGluaXRpYWxPZmZzZXQ7CiAgICAgIHRoaXMudXNlQXRvbWljcyA9IHVzZUF0b21pY3M7CiAgICAgIHRoaXMuc3RyZWFtID0gc3RyZWFtOwoKICAgICAgdGhpcy5kZWJ1ZyA9IGRlYnVnOwogICAgICB0aGlzLm5hbWUgPSBuYW1lOwoKICAgICAgaWYgKHRoaXMudXNlQXRvbWljcykgewogICAgICAgIC8vIFRoZSBidWZmZXIgc3RhcnRzIG91dCBhcyB3cml0ZWFibGUKICAgICAgICBBdG9taWNzLnN0b3JlKHRoaXMuYXRvbWljVmlldywgMCwgV1JJVEVBQkxFKTsKICAgICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmF0b21pY1ZpZXdbMF0gPSBXUklURUFCTEU7CiAgICAgIH0KICAgIH0KCiAgICBsb2coLi4uYXJncykgewogICAgICBpZiAodGhpcy5kZWJ1ZykgewogICAgICAgIGNvbnNvbGUubG9nKGBbd3JpdGVyOiAke3RoaXMubmFtZX1dYCwgLi4uYXJncyk7CiAgICAgIH0KICAgIH0KCiAgICB3YWl0UmVhZChuYW1lKSB7CiAgICAgIGlmICh0aGlzLnVzZUF0b21pY3MpIHsKICAgICAgICB0aGlzLmxvZyhgd2FpdGluZyBmb3IgJHtuYW1lfWApOwogICAgICAgIC8vIFN3aXRjaCB0byB3cml0YWJsZQogICAgICAgIC8vIEF0b21pY3Muc3RvcmUodGhpcy5hdG9taWNWaWV3LCAwLCAxKTsKCiAgICAgICAgbGV0IHByZXYgPSBBdG9taWNzLmNvbXBhcmVFeGNoYW5nZSgKICAgICAgICAgIHRoaXMuYXRvbWljVmlldywKICAgICAgICAgIDAsCiAgICAgICAgICBXUklURUFCTEUsCiAgICAgICAgICBSRUFEQUJMRQogICAgICAgICk7CgogICAgICAgIGlmIChwcmV2ICE9PSBXUklURUFCTEUpIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigKICAgICAgICAgICAgJ1dyb3RlIHNvbWV0aGluZyBpbnRvIHVud3JpdGFibGUgYnVmZmVyISBUaGlzIGlzIGRpc2FzdHJvdXMnCiAgICAgICAgICApOwogICAgICAgIH0KCiAgICAgICAgQXRvbWljcy5ub3RpZnkodGhpcy5hdG9taWNWaWV3LCAwKTsKCiAgICAgICAgd2hpbGUgKEF0b21pY3MubG9hZCh0aGlzLmF0b21pY1ZpZXcsIDApID09PSBSRUFEQUJMRSkgewogICAgICAgICAgLy8gY29uc29sZS5sb2coJ3dhaXRpbmcgdG8gYmUgcmVhZC4uLicpOwogICAgICAgICAgQXRvbWljcy53YWl0KHRoaXMuYXRvbWljVmlldywgMCwgUkVBREFCTEUsIDUwMCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmxvZyhgcmVzdW1lZCBmb3IgJHtuYW1lfWApOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXRvbWljVmlld1swXSA9IFJFQURBQkxFOwogICAgICB9CgogICAgICB0aGlzLm9mZnNldCA9IDQ7CiAgICB9CgogICAgZmluYWxpemUoKSB7CiAgICAgIHRoaXMubG9nKCdmaW5hbGl6aW5nJyk7CiAgICAgIGxldCBkYXRhVmlldyA9IG5ldyBEYXRhVmlldyh0aGlzLmJ1ZmZlciwgdGhpcy5vZmZzZXQpOwogICAgICBkYXRhVmlldy5zZXRVaW50MzIoMCwgRklOQUxJWkVEKTsKICAgICAgdGhpcy53YWl0UmVhZCgnZmluYWxpemUnKTsKICAgIH0KCiAgICBzdHJpbmcoc3RyKSB7CiAgICAgIHRoaXMubG9nKCdzdHJpbmcnLCBzdHIpOwoKICAgICAgbGV0IGJ5dGVMZW5ndGggPSBzdHIubGVuZ3RoICogMjsKICAgICAgdGhpcy5faW50MzIoYnl0ZUxlbmd0aCk7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0LCBieXRlTGVuZ3RoKTsKICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBzdHIubGVuZ3RoOyBpKyspIHsKICAgICAgICBkYXRhVmlldy5zZXRVaW50MTYoaSAqIDIsIHN0ci5jaGFyQ29kZUF0KGkpKTsKICAgICAgfQoKICAgICAgdGhpcy5vZmZzZXQgKz0gYnl0ZUxlbmd0aDsKICAgICAgdGhpcy53YWl0UmVhZCgnc3RyaW5nJyk7CiAgICB9CgogICAgX2ludDMyKG51bSkgewogICAgICBsZXQgYnl0ZUxlbmd0aCA9IDQ7CgogICAgICBsZXQgZGF0YVZpZXcgPSBuZXcgRGF0YVZpZXcodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KTsKICAgICAgZGF0YVZpZXcuc2V0SW50MzIoMCwgbnVtKTsKCiAgICAgIHRoaXMub2Zmc2V0ICs9IGJ5dGVMZW5ndGg7CiAgICB9CgogICAgaW50MzIobnVtKSB7CiAgICAgIHRoaXMubG9nKCdpbnQzMicsIG51bSk7CiAgICAgIHRoaXMuX2ludDMyKG51bSk7CiAgICAgIHRoaXMud2FpdFJlYWQoJ2ludDMyJyk7CiAgICB9CgogICAgYnl0ZXMoYnVmZmVyKSB7CiAgICAgIHRoaXMubG9nKCdieXRlcycsIGJ1ZmZlcik7CgogICAgICBsZXQgYnl0ZUxlbmd0aCA9IGJ1ZmZlci5ieXRlTGVuZ3RoOwogICAgICB0aGlzLl9pbnQzMihieXRlTGVuZ3RoKTsKICAgICAgbmV3IFVpbnQ4QXJyYXkodGhpcy5idWZmZXIsIHRoaXMub2Zmc2V0KS5zZXQobmV3IFVpbnQ4QXJyYXkoYnVmZmVyKSk7CgogICAgICB0aGlzLm9mZnNldCArPSBieXRlTGVuZ3RoOwogICAgICB0aGlzLndhaXRSZWFkKCdieXRlcycpOwogICAgfQogIH0KCiAgbGV0IGlzUHJvYmFibHlTYWZhcmkgPSAvXigoPyFjaHJvbWV8YW5kcm9pZCkuKSpzYWZhcmkvaS50ZXN0KAogICAgbmF2aWdhdG9yLnVzZXJBZ2VudAogICk7CgogIGxldCBvcGVuRGJzID0gbmV3IE1hcCgpOwogIGxldCB0cmFuc2FjdGlvbnMgPSBuZXcgTWFwKCk7CgogIGZ1bmN0aW9uIGFzc2VydChjb25kLCBtc2cpIHsKICAgIGlmICghY29uZCkgewogICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTsKICAgIH0KICB9CgogIGxldCBMT0NLX1RZUEVTID0gewogICAgTk9ORTogMCwKICAgIFNIQVJFRDogMSwKICAgIFJFU0VSVkVEOiAyLAogICAgUEVORElORzogMywKICAgIEVYQ0xVU0lWRTogNAogIH07CgogIC8vIFdlIHVzZSBsb25nLWxpdmVkIHRyYW5zYWN0aW9ucywgYW5kIGBUcmFuc2FjdGlvbmAga2VlcHMgdGhlCiAgLy8gdHJhbnNhY3Rpb24gc3RhdGUuIEl0IGltcGxlbWVudHMgYW4gb3B0aW1hbCB3YXkgdG8gcGVyZm9ybQogIC8vIHJlYWQvd3JpdGVzIHdpdGgga25vd2xlZGdlIG9mIGhvdyBzcWxpdGUgYXNrcyBmb3IgdGhlbSwgYW5kIGFsc28KICAvLyBpbXBsZW1lbnRzIGEgbG9ja2luZyBtZWNoYW5pc20gdGhhdCBtYXBzIHRvIGhvdyBzcWxpdGUgbG9ja3Mgd29yay4KICBjbGFzcyBUcmFuc2FjdGlvbiB7CiAgICBjb25zdHJ1Y3RvcihkYiwgaW5pdGlhbE1vZGUgPSAncmVhZG9ubHknKSB7CiAgICAgIHRoaXMuZGIgPSBkYjsKICAgICAgdGhpcy50cmFucyA9IHRoaXMuZGIudHJhbnNhY3Rpb24oWydkYXRhJ10sIGluaXRpYWxNb2RlKTsKICAgICAgdGhpcy5zdG9yZSA9IHRoaXMudHJhbnMub2JqZWN0U3RvcmUoJ2RhdGEnKTsKICAgICAgdGhpcy5sb2NrVHlwZSA9CiAgICAgICAgaW5pdGlhbE1vZGUgPT09ICdyZWFkb25seScgPyBMT0NLX1RZUEVTLlNIQVJFRCA6IExPQ0tfVFlQRVMuRVhDTFVTSVZFOwoKICAgICAgLy8gVGhlcmUgaXMgbm8gbmVlZCBmb3IgdXMgdG8gY2FjaGUgYmxvY2tzLiBVc2Ugc3FsaXRlJ3MKICAgICAgLy8gYGNhY2hlX3NpemVgIGZvciB0aGF0IGFuZCBpdCB3aWxsIGF1dG9tYXRpY2FsbHkgZG8gaXQuIEhvd2V2ZXIsCiAgICAgIC8vIHdlIGRvIHN0aWxsIGtlZXAgYSBjYWNoZSBvZiB0aGUgZmlyc3QgYmxvY2sgZm9yIHRoZSBkdXJhdGlvbiBvZgogICAgICAvLyB0aGlzIHRyYW5zYWN0aW9uIGJlY2F1c2Ugb2YgaG93IGxvY2tpbmcgd29ya3M7IHRoaXMgYXZvaWRzIGEKICAgICAgLy8gZmV3IGV4dHJhIHJlYWRzIGFuZCBhbGxvd3MgdXMgdG8gZGV0ZWN0IGNoYW5nZXMgZHVyaW5nCiAgICAgIC8vIHVwZ3JhZGluZyAoc2VlIGB1cGdyYWRlRXhjbHVzaXZlYCkKICAgICAgdGhpcy5jYWNoZWRGaXJzdEJsb2NrID0gbnVsbDsKCiAgICAgIHRoaXMuY3Vyc29yID0gbnVsbDsKICAgICAgdGhpcy5wcmV2UmVhZHMgPSBudWxsOwogICAgfQoKICAgIGFzeW5jIHByZWZldGNoRmlyc3RCbG9jayh0aW1lb3V0KSB7CiAgICAgIC8vIFRPRE86IGltcGxlbWVudCB0aW1lb3V0CgogICAgICAvLyBHZXQgdGhlIGZpcnN0IGJsb2NrIGFuZCBjYWNoZSBpdAogICAgICBsZXQgYmxvY2sgPSBhd2FpdCB0aGlzLmdldCgwKTsKICAgICAgdGhpcy5jYWNoZWRGaXJzdEJsb2NrID0gYmxvY2s7CiAgICAgIHJldHVybiBibG9jazsKICAgIH0KCiAgICBhc3luYyB3YWl0Q29tcGxldGUoKSB7CiAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgLy8gRWFnZXJseSBjb21taXQgaXQgZm9yIGJldHRlciBwZXJmLiBOb3RlIHRoYXQgKip0aGlzIGFzc3VtZXMKICAgICAgICAvLyB0aGUgdHJhbnNhY3Rpb24gaXMgb3BlbioqIGFzIGBjb21taXRgIHdpbGwgdGhyb3cgYW4gZXJyb3IgaWYKICAgICAgICAvLyBpdCdzIGFscmVhZHkgY2xvc2VkICh3aGljaCBzaG91bGQgbmV2ZXIgYmUgdGhlIGNhc2UgZm9yIHVzKQogICAgICAgIHRoaXMuY29tbWl0KCk7CgogICAgICAgIGlmICh0aGlzLmxvY2tUeXBlID09PSBMT0NLX1RZUEVTLkVYQ0xVU0lWRSkgewogICAgICAgICAgLy8gV2FpdCB1bnRpbCBhbGwgd3JpdGVzIGFyZSBjb21taXR0ZWQKICAgICAgICAgIHRoaXMudHJhbnMub25jb21wbGV0ZSA9IGUgPT4gcmVzb2x2ZSgpOwoKICAgICAgICAgIC8vIFRPRE86IElzIGl0IE9LIHRvIGFkZCB0aGlzIGxhdGVyLCBhZnRlciBhbiBlcnJvciBtaWdodCBoYXZlCiAgICAgICAgICAvLyBoYXBwZW5lZD8gV2lsbCBpdCBob2xkIHRoZSBlcnJvciBhbmQgZmlyZSB0aGlzIHdoZW4gd2UKICAgICAgICAgIC8vIGF0dGFjaGVkIGl0PyBXZSBtaWdodCB3YW50IHRvIGVhZ2VybHkgY3JlYXRlIHRoZSBwcm9taXNlCiAgICAgICAgICAvLyB3aGVuIGNyZWF0aW5nIHRoZSB0cmFuc2FjdGlvbiBhbmQgcmV0dXJuIGl0IGhlcmUKICAgICAgICAgIHRoaXMudHJhbnMub25lcnJvciA9IGUgPT4gcmVqZWN0KGUpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaXNQcm9iYWJseVNhZmFyaSkgewogICAgICAgICAgICAvLyBTYWZhcmkgaGFzIGEgYnVnIHdoZXJlIHNvbWV0aW1lcyB0aGUgSURCIGdldHMgYmxvY2tlZAogICAgICAgICAgICAvLyBwZXJtYW5lbnRseSBpZiB5b3UgcmVmcmVzaCB0aGUgcGFnZSB3aXRoIGFuIG9wZW4KICAgICAgICAgICAgLy8gdHJhbnNhY3Rpb24uIFlvdSBoYXZlIHRvIHJlc3RhcnQgdGhlIGJyb3dzZXIgdG8gZml4IGl0LgogICAgICAgICAgICAvLyBXZSB3YWl0IGZvciByZWFkb25seSB0cmFuc2FjdGlvbnMgdG8gZmluaXNoIHRvbywgYnV0IHRoaXMKICAgICAgICAgICAgLy8gaXMgYSBwZXJmIGhpdAogICAgICAgICAgICB0aGlzLnRyYW5zLm9uY29tcGxldGUgPSBlID0+IHJlc29sdmUoKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIC8vIE5vIG5lZWQgdG8gd2FpdCBvbiBhbnl0aGluZyBpbiBhIHJlYWQtb25seSB0cmFuc2FjdGlvbi4KICAgICAgICAgICAgLy8gTm90ZSB0aGF0IGVycm9ycyBkdXJpbmcgcmVhZHMgYXJlYSBhbHdheXMgaGFuZGxlZCBieSB0aGUKICAgICAgICAgICAgLy8gcmVhZCByZXF1ZXN0LgogICAgICAgICAgICByZXNvbHZlKCk7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICBjb21taXQoKSB7CiAgICAgIC8vIFNhZmFyaSBkb2Vzbid0IHN1cHBvcnQgdGhpcyBtZXRob2QgeWV0ICh0aGlzIGlzIGp1c3QgYW4KICAgICAgLy8gb3B0aW1pemF0aW9uKQogICAgICBpZiAodGhpcy50cmFucy5jb21taXQpIHsKICAgICAgICB0aGlzLnRyYW5zLmNvbW1pdCgpOwogICAgICB9CiAgICB9CgogICAgYXN5bmMgdXBncmFkZUV4Y2x1c2l2ZSgpIHsKICAgICAgdGhpcy5jb21taXQoKTsKICAgICAgdGhpcy50cmFucyA9IHRoaXMuZGIudHJhbnNhY3Rpb24oWydkYXRhJ10sICdyZWFkd3JpdGUnKTsKICAgICAgdGhpcy5zdG9yZSA9IHRoaXMudHJhbnMub2JqZWN0U3RvcmUoJ2RhdGEnKTsKICAgICAgdGhpcy5sb2NrVHlwZSA9IExPQ0tfVFlQRVMuRVhDTFVTSVZFOwoKICAgICAgbGV0IGNhY2hlZDAgPSB0aGlzLmNhY2hlZEZpcnN0QmxvY2s7CgogICAgICAvLyBEbyBhIHJlYWQKICAgICAgbGV0IGJsb2NrID0gYXdhaXQgdGhpcy5wcmVmZXRjaEZpcnN0QmxvY2soNTAwKTsKICAgICAgLy8gVE9ETzogd2hlbiB0aW1lb3V0cyBhcmUgaW1wbGVtZW50ZWQsIGRldGVjdCB0aW1lb3V0IGFuZCByZXR1cm4gQlVTWQoKICAgICAgaWYgKGNhY2hlZDAgPT0gbnVsbCAmJiBibG9jayA9PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZm9yIChsZXQgaSA9IDI0OyBpIDwgNDA7IGkrKykgewogICAgICAgICAgaWYgKGJsb2NrW2ldICE9PSBjYWNoZWQwW2ldKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIGRvd25ncmFkZVNoYXJlZCgpIHsKICAgICAgdGhpcy5jb21taXQoKTsKICAgICAgdGhpcy50cmFucyA9IHRoaXMuZGIudHJhbnNhY3Rpb24oWydkYXRhJ10sICdyZWFkb25seScpOwogICAgICB0aGlzLnN0b3JlID0gdGhpcy50cmFucy5vYmplY3RTdG9yZSgnZGF0YScpOwogICAgICB0aGlzLmxvY2tUeXBlID0gTE9DS19UWVBFUy5TSEFSRUQ7CiAgICB9CgogICAgYXN5bmMgZ2V0KGtleSkgewogICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGxldCByZXEgPSB0aGlzLnN0b3JlLmdldChrZXkpOwogICAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBlID0+IHsKICAgICAgICAgIHJlc29sdmUocmVxLnJlc3VsdCk7CiAgICAgICAgfTsKICAgICAgICByZXEub25lcnJvciA9IGUgPT4gcmVqZWN0KGUpOwogICAgICB9KTsKICAgIH0KCiAgICBnZXRSZWFkRGlyZWN0aW9uKCkgewogICAgICAvLyBUaGVyZSBhcmUgYSB0d28gd2F5cyB3ZSBjYW4gcmVhZCBkYXRhOiBhIGRpcmVjdCBgZ2V0YCByZXF1ZXN0CiAgICAgIC8vIG9yIG9wZW5pbmcgYSBjdXJzb3IgYW5kIGl0ZXJhdGluZyB0aHJvdWdoIGRhdGEuIFdlIGRvbid0IGtub3cKICAgICAgLy8gd2hhdCBmdXR1cmUgcmVhZHMgbG9vayBsaWtlLCBzbyB3ZSBkb24ndCBrbm93IHRoZSBiZXN0IHN0cmF0ZWd5CiAgICAgIC8vIHRvIHBpY2suIEFsd2F5cyBjaG9vc2luZyBvbmUgc3RyYXRlZ3kgZm9yZ29lcyBhIGxvdCBvZgogICAgICAvLyBvcHRpbWl6YXRpb24sIGJlY2F1c2UgaXRlcmF0aW5nIHdpdGggYSBjdXJzb3IgaXMgYSBsb3QgZmFzdGVyCiAgICAgIC8vIHRoYW4gbWFueSBgZ2V0YCBjYWxscy4gT24gdGhlIG90aGVyIGhhbmQsIG9wZW5pbmcgYSBjdXJzb3IgaXMKICAgICAgLy8gc2xvdywgYW5kIHNvIGlzIGNhbGxpbmcgYGFkdmFuY2VgIHRvIG1vdmUgYSBjdXJzb3Igb3ZlciBhIGh1Z2UKICAgICAgLy8gcmFuZ2UgKGxpa2UgbW92aW5nIGl0IDEwMDAgaXRlbXMgbGF0ZXIpLCBzbyBtYW55IGBnZXRgIGNhbGxzIHdvdWxkCiAgICAgIC8vIGJlIGZhc3Rlci4gSW4gZ2VuZXJhbDoKICAgICAgLy8KICAgICAgLy8gKiBNYW55IGBnZXRgIGNhbGxzIGFyZSBmYXN0ZXIgd2hlbiBkb2luZyByYW5kb20gYWNjZXNzZXMKICAgICAgLy8gKiBJdGVyYXRpbmcgd2l0aCBhIGN1cnNvciBpcyBmYXN0ZXIgaWYgZG9pbmcgbW9zdGx5IHNlcXVlbnRpYWwKICAgICAgLy8gICBhY2Nlc3NlcwogICAgICAvLwogICAgICAvLyBXZSBpbXBsZW1lbnQgYSBoZXVyaXN0aWMgYW5kIGtlZXBzIHRyYWNrIG9mIHRoZSBsYXN0IDMgcmVhZHMKICAgICAgLy8gYW5kIGRldGVjdHMgd2hlbiB0aGV5IGFyZSBtb3N0bHkgc2VxdWVudGlhbC4gSWYgdGhleSBhcmUsIHdlCiAgICAgIC8vIG9wZW4gYSBjdXJzb3IgYW5kIHN0YXJ0IHJlYWRpbmcgYnkgaXRlcmF0aW5nIGl0LiBJZiBub3QsIHdlIGRvCiAgICAgIC8vIGRpcmVjdCBgZ2V0YCBjYWxscy4KICAgICAgLy8KICAgICAgLy8gT24gdG9wIG9mIGFsbCBvZiB0aGlzLCBlYWNoIGJyb3dzZXIgaGFzIGRpZmZlcmVudCBwZXJmCiAgICAgIC8vIGNoYXJhY3RlcmlzdGljcy4gV2Ugd2lsbCBwcm9iYWJseSB3YW50IHRvIG1ha2UgdGhlc2UgdGhyZXNob2xkcwogICAgICAvLyBjb25maWd1cmFibGUgc28gdGhlIHVzZXIgY2FuIGNoYW5nZSB0aGVtIHBlci1icm93c2VyIGlmIG5lZWRlZCwKICAgICAgLy8gYXMgd2VsbCBhcyBmaW5lLXR1bmluZyB0aGVtIGZvciB0aGVpciB1c2FnZSBvZiBzcWxpdGUuCgogICAgICBsZXQgcHJldlJlYWRzID0gdGhpcy5wcmV2UmVhZHM7CiAgICAgIGlmIChwcmV2UmVhZHMpIHsKICAgICAgICAvLyBIYXMgdGhlcmUgYmVlbiAzIGZvcndhcmQgc2VxdWVudGlhbCByZWFkcyB3aXRoaW4gMTAgYmxvY2tzPwogICAgICAgIGlmICgKICAgICAgICAgIHByZXZSZWFkc1swXSA8IHByZXZSZWFkc1sxXSAmJgogICAgICAgICAgcHJldlJlYWRzWzFdIDwgcHJldlJlYWRzWzJdICYmCiAgICAgICAgICBwcmV2UmVhZHNbMl0gLSBwcmV2UmVhZHNbMF0gPCAxMAogICAgICAgICkgewogICAgICAgICAgcmV0dXJuICduZXh0JzsKICAgICAgICB9CgogICAgICAgIC8vIEhhcyB0aGVyZSBiZWVuIDMgYmFja3dhcmRzIHNlcXVlbnRpYWwgcmVhZHMgd2l0aGluIDEwIGJsb2Nrcz8KICAgICAgICBpZiAoCiAgICAgICAgICBwcmV2UmVhZHNbMF0gPiBwcmV2UmVhZHNbMV0gJiYKICAgICAgICAgIHByZXZSZWFkc1sxXSA+IHByZXZSZWFkc1syXSAmJgogICAgICAgICAgcHJldlJlYWRzWzBdIC0gcHJldlJlYWRzWzJdIDwgMTAKICAgICAgICApIHsKICAgICAgICAgIHJldHVybiAncHJldic7CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gbnVsbDsKICAgIH0KCiAgICByZWFkKHBvc2l0aW9uKSB7CiAgICAgIGxldCB3YWl0Q3Vyc29yID0gKCkgPT4gewogICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CiAgICAgICAgICBpZiAodGhpcy5jdXJzb3JQcm9taXNlICE9IG51bGwpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKAogICAgICAgICAgICAgICd3YWl0Q3Vyc29yKCkgY2FsbGVkIGJ1dCBzb21ldGhpbmcgZWxzZSBpcyBhbHJlYWR5IHdhaXRpbmcnCiAgICAgICAgICAgICk7CiAgICAgICAgICB9CiAgICAgICAgICB0aGlzLmN1cnNvclByb21pc2UgPSB7IHJlc29sdmUsIHJlamVjdCB9OwogICAgICAgIH0pOwogICAgICB9OwoKICAgICAgaWYgKHRoaXMuY3Vyc29yKSB7CiAgICAgICAgbGV0IGN1cnNvciA9IHRoaXMuY3Vyc29yOwoKICAgICAgICBpZiAoCiAgICAgICAgICBjdXJzb3IuZGlyZWN0aW9uID09PSAnbmV4dCcgJiYKICAgICAgICAgIHBvc2l0aW9uID4gY3Vyc29yLmtleSAmJgogICAgICAgICAgcG9zaXRpb24gPCBjdXJzb3Iua2V5ICsgMTAwCiAgICAgICAgKSB7CgogICAgICAgICAgY3Vyc29yLmFkdmFuY2UocG9zaXRpb24gLSBjdXJzb3Iua2V5KTsKICAgICAgICAgIHJldHVybiB3YWl0Q3Vyc29yKCk7CiAgICAgICAgfSBlbHNlIGlmICgKICAgICAgICAgIGN1cnNvci5kaXJlY3Rpb24gPT09ICdwcmV2JyAmJgogICAgICAgICAgcG9zaXRpb24gPCBjdXJzb3Iua2V5ICYmCiAgICAgICAgICBwb3NpdGlvbiA+IGN1cnNvci5rZXkgLSAxMDAKICAgICAgICApIHsKCiAgICAgICAgICBjdXJzb3IuYWR2YW5jZShjdXJzb3Iua2V5IC0gcG9zaXRpb24pOwogICAgICAgICAgcmV0dXJuIHdhaXRDdXJzb3IoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgLy8gRGl0Y2ggdGhlIGN1cnNvcgogICAgICAgICAgdGhpcy5jdXJzb3IgPSBudWxsOwogICAgICAgICAgcmV0dXJuIHRoaXMucmVhZChwb3NpdGlvbik7CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIC8vIFdlIGRvbid0IGFscmVhZHkgaGF2ZSBhIGN1cnNvci4gV2UgbmVlZCB0byBhIGZyZXNoIHJlYWQ7CiAgICAgICAgLy8gc2hvdWxkIHdlIG9wZW4gYSBjdXJzb3Igb3IgY2FsbCBgZ2V0YD8KCiAgICAgICAgbGV0IGRpciA9IHRoaXMuZ2V0UmVhZERpcmVjdGlvbigpOwogICAgICAgIGlmIChkaXIpIHsKICAgICAgICAgIC8vIE9wZW4gYSBjdXJzb3IKICAgICAgICAgIHRoaXMucHJldlJlYWRzID0gbnVsbDsKCiAgICAgICAgICBsZXQga2V5UmFuZ2U7CiAgICAgICAgICBpZiAoZGlyID09PSAncHJldicpIHsKICAgICAgICAgICAga2V5UmFuZ2UgPSBJREJLZXlSYW5nZS51cHBlckJvdW5kKHBvc2l0aW9uKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtleVJhbmdlID0gSURCS2V5UmFuZ2UubG93ZXJCb3VuZChwb3NpdGlvbik7CiAgICAgICAgICB9CgogICAgICAgICAgbGV0IHJlcSA9IHRoaXMuc3RvcmUub3BlbkN1cnNvcihrZXlSYW5nZSwgZGlyKTsKCiAgICAgICAgICByZXEub25zdWNjZXNzID0gZSA9PiB7CgogICAgICAgICAgICBsZXQgY3Vyc29yID0gZS50YXJnZXQucmVzdWx0OwogICAgICAgICAgICB0aGlzLmN1cnNvciA9IGN1cnNvcjsKCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvclByb21pc2UgPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGRhdGEgZnJvbSBjdXJzb3IgYnV0IG5vdGhpbmcgaXMgd2FpdGluZyBpdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY3Vyc29yUHJvbWlzZS5yZXNvbHZlKGN1cnNvciA/IGN1cnNvci52YWx1ZSA6IG51bGwpOwogICAgICAgICAgICB0aGlzLmN1cnNvclByb21pc2UgPSBudWxsOwogICAgICAgICAgfTsKICAgICAgICAgIHJlcS5vbmVycm9yID0gZSA9PiB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdDdXJzb3IgZmFpbHVyZTonLCBlKTsKCiAgICAgICAgICAgIGlmICh0aGlzLmN1cnNvclByb21pc2UgPT0gbnVsbCkgewogICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGRhdGEgZnJvbSBjdXJzb3IgYnV0IG5vdGhpbmcgaXMgd2FpdGluZyBpdCcpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuY3Vyc29yUHJvbWlzZS5yZWplY3QoZSk7CiAgICAgICAgICAgIHRoaXMuY3Vyc29yUHJvbWlzZSA9IG51bGw7CiAgICAgICAgICB9OwoKICAgICAgICAgIHJldHVybiB3YWl0Q3Vyc29yKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmICh0aGlzLnByZXZSZWFkcyA9PSBudWxsKSB7CiAgICAgICAgICAgIHRoaXMucHJldlJlYWRzID0gWzAsIDAsIDBdOwogICAgICAgICAgfQogICAgICAgICAgdGhpcy5wcmV2UmVhZHMucHVzaChwb3NpdGlvbik7CiAgICAgICAgICB0aGlzLnByZXZSZWFkcy5zaGlmdCgpOwoKICAgICAgICAgIHJldHVybiB0aGlzLmdldChwb3NpdGlvbik7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgYXN5bmMgc2V0KGl0ZW0pIHsKICAgICAgdGhpcy5wcmV2UmVhZHMgPSBudWxsOwoKICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgICBsZXQgcmVxID0gdGhpcy5zdG9yZS5wdXQoaXRlbS52YWx1ZSwgaXRlbS5rZXkpOwogICAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBlID0+IHJlc29sdmUocmVxLnJlc3VsdCk7CiAgICAgICAgcmVxLm9uZXJyb3IgPSBlID0+IHJlamVjdChlKTsKICAgICAgfSk7CiAgICB9CgogICAgYXN5bmMgYnVsa1NldChpdGVtcykgewogICAgICB0aGlzLnByZXZSZWFkcyA9IG51bGw7CgogICAgICBmb3IgKGxldCBpdGVtIG9mIGl0ZW1zKSB7CiAgICAgICAgdGhpcy5zdG9yZS5wdXQoaXRlbS52YWx1ZSwgaXRlbS5rZXkpOwogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmdW5jdGlvbiBsb2FkRGIobmFtZSkgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKICAgICAgaWYgKG9wZW5EYnMuZ2V0KG5hbWUpKSB7CiAgICAgICAgcmVzb2x2ZShvcGVuRGJzLmdldChuYW1lKSk7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICBjb25zb2xlLmxvZygnb3BlbmluZycsIG5hbWUpOwoKICAgICAgbGV0IHJlcSA9IGdsb2JhbFRoaXMuaW5kZXhlZERCLm9wZW4obmFtZSwgMSk7CiAgICAgIHJlcS5vbnN1Y2Nlc3MgPSBldmVudCA9PiB7CiAgICAgICAgY29uc29sZS5sb2coJ2RiIGlzIG9wZW4hJywgbmFtZSk7CiAgICAgICAgbGV0IGRiID0gZXZlbnQudGFyZ2V0LnJlc3VsdDsKCiAgICAgICAgZGIub252ZXJzaW9uY2hhbmdlID0gKCkgPT4gewogICAgICAgICAgLy8gVE9ETzogTm90aWZ5IHRoZSB1c2VyIHNvbWVob3cKICAgICAgICAgIGNvbnNvbGUubG9nKCdjbG9zaW5nIGJlY2F1c2UgdmVyc2lvbiBjaGFuZ2VkJyk7CiAgICAgICAgICBkYi5jbG9zZSgpOwogICAgICAgICAgb3BlbkRicy5kZWxldGUobmFtZSk7CiAgICAgICAgfTsKCiAgICAgICAgZGIub25jbG9zZSA9ICgpID0+IHsKICAgICAgICAgIG9wZW5EYnMuZGVsZXRlKG5hbWUpOwogICAgICAgIH07CgogICAgICAgIG9wZW5EYnMuc2V0KG5hbWUsIGRiKTsKICAgICAgICByZXNvbHZlKGRiKTsKICAgICAgfTsKICAgICAgcmVxLm9udXBncmFkZW5lZWRlZCA9IGV2ZW50ID0+IHsKICAgICAgICBsZXQgZGIgPSBldmVudC50YXJnZXQucmVzdWx0OwogICAgICAgIGlmICghZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucygnZGF0YScpKSB7CiAgICAgICAgICBkYi5jcmVhdGVPYmplY3RTdG9yZSgnZGF0YScpOwogICAgICAgIH0KICAgICAgfTsKICAgICAgcmVxLm9uYmxvY2tlZCA9IGUgPT4gY29uc29sZS5sb2coJ2Jsb2NrZWQnLCBlKTsKICAgICAgcmVxLm9uZXJyb3IgPSByZXEub25hYm9ydCA9IGUgPT4gcmVqZWN0KGUudGFyZ2V0LmVycm9yKTsKICAgIH0pOwogIH0KCiAgZnVuY3Rpb24gY2xvc2VEYihuYW1lKSB7CiAgICBsZXQgb3BlbkRiID0gb3BlbkRicy5nZXQobmFtZSk7CiAgICBpZiAob3BlbkRiKSB7CiAgICAgIGNvbnNvbGUubG9nKCdjbG9zaW5nIGRiJyk7CiAgICAgIG9wZW5EYi5jbG9zZSgpOwogICAgICBvcGVuRGJzLmRlbGV0ZShuYW1lKTsKICAgIH0KICB9CgogIGZ1bmN0aW9uIGdldFRyYW5zYWN0aW9uKG5hbWUpIHsKICAgIHJldHVybiB0cmFuc2FjdGlvbnMuZ2V0KG5hbWUpOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gd2l0aFRyYW5zYWN0aW9uKG5hbWUsIG1vZGUsIGZ1bmMpIHsKICAgIGxldCB0cmFucyA9IHRyYW5zYWN0aW9ucy5nZXQobmFtZSk7CiAgICBpZiAodHJhbnMpIHsKICAgICAgLy8gSWYgYSB0cmFuc2FjdGlvbiBhbHJlYWR5IGV4aXN0cywgdGhhdCBtZWFucyB0aGUgZmlsZSBoYXMgYmVlbgogICAgICAvLyBsb2NrZWQuIFdlIGRvbid0IGZ1bGx5IHN1cHBvcnQgYXJiaXRyYXJ5IG5lc3RlZCB0cmFuc2FjdGlvbnMsCiAgICAgIC8vIGFzIHNlZW4gYmVsb3cgKHdlIHdvbid0IHVwZ3JhZGUgYSBgcmVhZG9ubHlgIHRvIGByZWFkd3JpdGVgCiAgICAgIC8vIGF1dG9tYXRpY2FsbHkpIGFuZCB0aGlzIGlzIG1haW5seSBmb3IgdGhlIHVzZSBjYXNlIHdoZXJlIHNxbGl0ZQogICAgICAvLyBsb2NrcyB0aGUgZGIgYW5kIGNyZWF0ZXMgYSB0cmFuc2FjdGlvbiBmb3IgdGhlIGR1cmFjdGlvbiBvZiB0aGUKICAgICAgLy8gbG9jay4gV2UgZG9uJ3QgYWN0dWFsbHkgd3JpdGUgY29kZSBpbiBhIHdheSB0aGF0IGFzc3VtZXMgbmVzdGVkCiAgICAgIC8vIHRyYW5zYWN0aW9ucywgc28ganVzdCBlcnJvciBoZXJlCiAgICAgIGlmIChtb2RlID09PSAncmVhZHdyaXRlJyAmJiB0cmFucy5sb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5TSEFSRUQpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0F0dGVtcHRlZCB3cml0ZSBidXQgb25seSBoYXMgU0hBUkVEIGxvY2snKTsKICAgICAgfQogICAgICByZXR1cm4gZnVuYyh0cmFucyk7CiAgICB9CgogICAgLy8gT3V0c2lkZSB0aGUgc2NvcGUgb2YgYSBsb2NrLCBjcmVhdGUgYSB0ZW1wb3JhcnkgdHJhbnNhY3Rpb24KICAgIHRyYW5zID0gbmV3IFRyYW5zYWN0aW9uKGF3YWl0IGxvYWREYihuYW1lKSwgbW9kZSk7CiAgICBhd2FpdCBmdW5jKHRyYW5zKTsKICAgIGF3YWl0IHRyYW5zLndhaXRDb21wbGV0ZSgpOwogIH0KCiAgLy8gTG9ja2luZyBzdHJhdGVneToKICAvLwogIC8vICogV2UgbWFwIHNxbGl0ZSdzIGxvY2tzIG9udG8gSW5kZXhlZERCJ3MgdHJhbnNhY3Rpb24gc2VtYW50aWNzLgogIC8vICAgUmVhZCB0cmFuc2FjdGlvbnMgbWF5IGV4ZWN1dGUgaW4gcGFyYWxsZWwuIFJlYWQvd3JpdGUKICAvLyAgIHRyYW5zYWN0aW9ucyBhcmUgcXVldWVkIHVwIGFuZCB3YWl0IHVudGlsIGFsbCBwcmVjZWRpbmcKICAvLyAgIHJlYWQgdHJhbnNhY3Rpb25zIGZpbmlzaCBleGVjdXRpbmcuIFJlYWQgdHJhbnNhY3Rpb25zIHN0YXJ0ZWQKICAvLyAgIGFmdGVyIGEgcmVhZC93cml0ZSB0cmFuc2FjdGlvbiB3YWl0IHVudGlsIGl0IGlzIGZpbmlzaGVkLgogIC8vCiAgLy8gKiBJREIgdHJhbnNhY3Rpb25zIHdpbGwgd2FpdCBmb3JldmVyIHVudGlsIHRoZXkgY2FuIGV4ZWN1dGUgKGZvcgogIC8vICAgZXhhbXBsZSwgdGhleSBtYXkgYmUgYmxvY2tlZCBvbiBhIHJlYWQvd3JpdGUgdHJhbnNhY3Rpb24pLiBXZQogIC8vICAgZG9uJ3Qgd2FudCB0byBhbGxvdyBzcWxpdGUgdHJhbnNhY3Rpb25zIHRvIHdhaXQgZm9yZXZlciwgc28KICAvLyAgIHdlIG1hbnVhbGx5IHRpbWVvdXQgaWYgYSB0cmFuc2FjdGlvbiB0YWtlcyB0b28gbG9uZyB0bwogIC8vICAgc3RhcnQgZXhlY3V0aW5nLiBUaGlzIHNpbXVsYXRlcyB0aGUgYmVoYXZpb3Igb2YgYSBzcWxpdGUKICAvLyAgIGJhaWxpbmcgaWYgaXQgY2FuJ3QgcmVxdWlyZSBhIGxvY2suCiAgLy8KICAvLyAqIEEgU0hBUkVEIGxvY2sgd2FudHMgdG8gcmVhZCBmcm9tIHRoZSBkYi4gV2Ugc3RhcnQgYSByZWFkCiAgLy8gICB0cmFuc2FjdGlvbiBhbmQgcmVhZCB0aGUgZmlyc3QgYmxvY2ssIGFuZCBpZiB3ZSByZWFkIGl0IHdpdGhpbgogIC8vICAgNTAwbXMgd2UgY29uc2lkZXIgdGhlIGxvY2sgc3VjY2Vzc2Z1bC4gT3RoZXJ3aXNlIHRoZSBsb2NrCiAgLy8gICBmYWlsZWQgYW5kIHdlIHJldHVybiBTUUxJVEVfQlVTWS4gKFRoZXJlJ3Mgbm8gcGVyZiBkb3duc2lkZQogIC8vICAgdG8gcmVhZGluZyB0aGUgZmlyc3QgYmxvY2sgLSBpdCBoYXMgdG8gYmUgcmVhZCBhbnl3YXkgdG8gY2hlY2sKICAvLyAgIGJ5dGVzIDI0LTM5IGZvciB0aGUgY2hhbmdlIGNvdW50ZXIpCiAgLy8KICAvLyAqIEEgUkVTRVJWRUQgbG9jayBtZWFucyB0aGUgZGIgd2FudHMgdG8gc3RhcnQgd3JpdGluZyAodGhpbmsgb2YKICAvLyAgIGBCRUdJTiBUUkFOU0FDVElPTmApLiBPbmx5IG9uZSBwcm9jZXNzIGNhbiBvYnRhaW4gYSBSRVNFUlZFRAogIC8vICAgbG9jayBhdCBhIHRpbWUsIGJ1dCBub3JtYWxseSBzcWxpdGUgc3RpbGwgbGVhZHMgbmV3IHJlYWQgbG9ja3MKICAvLyAgIGhhcHBlbi4gSXQgaXNuJ3QgdW50aWwgYW4gRVhDTFVTSVZFIGxvY2sgaXMgaGVsZCB0aGF0IHJlYWRzIGFyZQogIC8vICAgYmxvY2tlZC4gSG93ZXZlciwgc2luY2Ugd2UgbmVlZCB0byBndWFyYW50ZWUgb25seSBvbmUgUkVTRVJWRUQKICAvLyAgIGxvY2sgYXQgb25jZSAob3RoZXJ3aXNlIGRhdGEgY291bGQgY2hhbmdlIGZyb20gYW5vdGhlciBwcm9jZXNzCiAgLy8gICB3aXRoaW4gYSB0cmFuc2FjdGlvbiwgY2F1c2luZyBmYXVsdHkgY2FjaGVzIGV0YykgdGhlIHNpbXBsZXN0CiAgLy8gICB0aGluZyB0byBkbyBpcyBnbyBhaGVhZCBhbmQgZ3JhYiBhIHJlYWQvd3JpdGUgdHJhbnNhY3Rpb24gdGhhdAogIC8vICAgcmVwcmVzZW50cyB0aGUgUkVTRVJWRUQgbG9jay4gVGhpcyB3aWxsIGJsb2NrIGFsbCByZWFkcyBmcm9tCiAgLy8gICBoYXBwZW5pbmcsIGFuZCBpcyBlc3NlbnRpYWxseSB0aGUgc2FtZSBhcyBhbiBFWENMVVNJVkUgbG9jay4KICAvLwogIC8vICAgICAqIFRoZSBtYWluIHByb2JsZW0gaGVyZSBpcyB3ZSBjYW4ndCAidXBncmFkZSIgYSBgcmVhZG9ubHlgCiAgLy8gICAgICAgdHJhbnNhY3Rpb24gdG8gYHJlYWR3cml0ZWAsIGJ1dCBuYXRpdmUgc3FsaXRlIGNhbiB1cGdyYWRlIGEKICAvLyAgICAgICBsb2NrIGZyb20gU0hBUkVEIHRvIFJFU0VSVkVELiBXZSBuZWVkIHRvIHN0YXJ0IGEgbmV3CiAgLy8gICAgICAgdHJhbnNhY3Rpb24gdG8gZG8gc28sIGFuZCBiZWNhdXNlIG9mIHRoYXQgdGhlcmUgbWlnaHQgYmUKICAvLyAgICAgICBvdGhlciBgcmVhZHdyaXRlYCB0cmFuc2FjdGlvbnMgdGhhdCBnZXQgcnVuIGR1cmluZyB0aGUKICAvLyAgICAgICAidXBncmFkZSIgd2hpY2ggaW52YWxpZGF0ZXMgdGhlIHdob2xlIGxvY2tpbmcgcHJvY2VzcyBhbmQKICAvLyAgICAgICBhbmQgY29ycnVwdHMgZGF0YS4KICAvLwogIC8vICogSWRlYWxseSwgd2UgY291bGQgdGVsbCBzcWxpdGUgdG8gc2tpcCBTSEFSRUQgbG9ja3MgZW50aXJlbHkuIFdlCiAgLy8gICBkb24ndCBuZWVkIHRoZW0gc2luY2Ugd2UgY2FuIHJlbHkgb24gSW5kZXhlZERCJ3Mgc2VtYW50aWNzLgogIC8vICAgVGhlbiB3aGVuIGl0IHdhbnRzIHRvIHN0YXJ0IHdyaXRpbmcsIHdlIGdldCBhIFJFU0VSVkVEIGxvY2sKICAvLyAgIHdpdGhvdXQgaGF2aW5nIHRvIHVwZ3JhZGUgZnJvbSBTSEFSRUQuIFRoaXMgd291bGQgc2F2ZSB1cwogIC8vICAgdGhlIGNvc3Qgb2YgYSBgcmVhZG9ubHlgIHRyYW5zYWN0aW9uIHdoZW4gd3JpdGluZzsgcmlnaHQgbm93CiAgLy8gICBpdCBtdXN0IG9wZW4gYSBgcmVhZG9ubHlgIHRyYW5zYWN0aW9uIGFuZCB0aGVuIGltbWVkaWF0ZWx5IG9wZW4KICAvLyAgIGEgYHJlYWR3cml0ZWAgdG8gdXBncmFkZSBpdC4gSSB0aG91Z2h0IG9mIGRlZmVycmluZyBvcGVuaW5nIHRoZQogIC8vICAgYHJlYWRvbmx5YCB0cmFuc2FjdGlvbiB1bnRpbCBzb21ldGhpbmcgaXMgYWN0dWFsbHkgcmVhZCwgYnV0CiAgLy8gICB1bmZvcnR1bmF0ZWx5IHNxbGl0ZSBvcGVucyBpdCwgcmVhZHMgdGhlIGZpcnN0IGJsb2NrLCBhbmQgdGhlbgogIC8vICAgdXBncmFkZXMgaXQuIFNvIHRoZXJlJ3Mgbm8gd2F5IGFyb3VuZCBpdC4gKFdlIGNhbid0IGFzc3VtZSBpdCdzCiAgLy8gICBhIGByZWFkd3JpdGVgIHRyYW5zYWN0aW9uIGF0IHRoYXQgcG9pbnQgc2luY2UgdGhhdCB3b3VsZCBhc3N1bWUKICAvLyAgIGFsbCBTSEFSRUQgbG9ja3MgYXJlIGByZWFkd3JpdGVgLCByZW1vdmluZyB0aGUgcG9zc2liaWxpdHkgb2YKICAvLyAgIGNvbmN1cnJlbnQgcmVhZHMpLgogIC8vCiAgLy8gKiBVcGdyYWRpbmcgdG8gYW4gRVhDTFVTSVZFIGxvY2sgaXMgYSBub29wLCBzaW5jZSB3ZSB0cmVhdCBSRVNFUlZFRAogIC8vICAgbG9ja3MgYXMgRVhDTFVTSVZFLgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZUxvY2sod3JpdGVyLCBuYW1lLCBsb2NrVHlwZSkgewogICAgLy8gY29uc29sZS5sb2coJ2xvY2tpbmcnLCBuYW1lLCBsb2NrVHlwZSwgcGVyZm9ybWFuY2Uubm93KCkpOwoKICAgIGxldCB0cmFucyA9IHRyYW5zYWN0aW9ucy5nZXQobmFtZSk7CiAgICBpZiAodHJhbnMpIHsKICAgICAgaWYgKGxvY2tUeXBlID4gdHJhbnMubG9ja1R5cGUpIHsKICAgICAgICAvLyBVcGdyYWRlIFNIQVJFRCB0byBFWENMVVNJVkUKICAgICAgICBhc3NlcnQoCiAgICAgICAgICB0cmFucy5sb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5TSEFSRUQsCiAgICAgICAgICBgVXByYWRpbmcgbG9jayB0eXBlIGZyb20gJHt0cmFucy5sb2NrVHlwZX0gaXMgaW52YWxpZGAKICAgICAgICApOwogICAgICAgIGFzc2VydCgKICAgICAgICAgIGxvY2tUeXBlID09PSBMT0NLX1RZUEVTLlJFU0VSVkVEIHx8IGxvY2tUeXBlID09PSBMT0NLX1RZUEVTLkVYQ0xVU0lWRSwKICAgICAgICAgIGBVcGdyYWRpbmcgbG9jayB0eXBlIHRvICR7bG9ja1R5cGV9IGlzIGludmFsaWRgCiAgICAgICAgKTsKCiAgICAgICAgbGV0IHN1Y2Nlc3MgPSBhd2FpdCB0cmFucy51cGdyYWRlRXhjbHVzaXZlKCk7CiAgICAgICAgd3JpdGVyLmludDMyKHN1Y2Nlc3MgPyAwIDogLTEpOwogICAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIElmIG5vdCB1cGdyYWRpbmcgYW5kIHdlIGFscmVhZHkgaGF2ZSBhIGxvY2ssIG1ha2Ugc3VyZSB0aGlzCiAgICAgICAgLy8gaXNuJ3QgYSBkb3duZ3JhZGUKICAgICAgICBhc3NlcnQoCiAgICAgICAgICB0cmFucy5sb2NrVHlwZSA9PT0gbG9ja1R5cGUsCiAgICAgICAgICBgRG93bmdyYWRpbmcgbG9jayB0byAke2xvY2tUeXBlfSBpcyBpbnZhbGlkYAogICAgICAgICk7CgogICAgICAgIHdyaXRlci5pbnQzMigwKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgYXNzZXJ0KAogICAgICAgIGxvY2tUeXBlID09PSBMT0NLX1RZUEVTLlNIQVJFRCwKICAgICAgICBgTmV3IGxvY2tzIG11c3Qgc3RhcnQgYXMgU0hBUkVEIGluc3RlYWQgb2YgJHtsb2NrVHlwZX1gCiAgICAgICk7CgogICAgICBsZXQgdHJhbnMgPSBuZXcgVHJhbnNhY3Rpb24oYXdhaXQgbG9hZERiKG5hbWUpKTsKICAgICAgaWYgKChhd2FpdCB0cmFucy5wcmVmZXRjaEZpcnN0QmxvY2soNTAwKSkgPT0gbnVsbCkgOwoKICAgICAgdHJhbnNhY3Rpb25zLnNldChuYW1lLCB0cmFucyk7CgogICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlVW5sb2NrKHdyaXRlciwgbmFtZSwgbG9ja1R5cGUpIHsKICAgIC8vIGNvbnNvbGUubG9nKCd1bmxvY2tpbmcnLCBuYW1lLCBsb2NrVHlwZSwgcGVyZm9ybWFuY2Uubm93KCkpOwoKICAgIGxldCB0cmFucyA9IGdldFRyYW5zYWN0aW9uKG5hbWUpOwoKICAgIGlmIChsb2NrVHlwZSA9PT0gTE9DS19UWVBFUy5TSEFSRUQpIHsKICAgICAgaWYgKHRyYW5zID09IG51bGwpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1VubG9jayBlcnJvciAoU0hBUkVEKTogbm8gdHJhbnNhY3Rpb24gcnVubmluZycpOwogICAgICB9CgogICAgICBpZiAodHJhbnMubG9ja1R5cGUgPT09IExPQ0tfVFlQRVMuRVhDTFVTSVZFKSB7CiAgICAgICAgdHJhbnMuZG93bmdyYWRlU2hhcmVkKCk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAobG9ja1R5cGUgPT09IExPQ0tfVFlQRVMuTk9ORSkgewogICAgICAvLyBJIHRob3VnaHQgd2UgY291bGQgYXNzdW1lIGEgbG9jayBpcyBhbHdheXMgb3BlbiB3aGVuIGB1bmxvY2tgCiAgICAgIC8vIGlzIGNhbGxlZCwgYnV0IGl0IGFsc28gY2FsbHMgYHVubG9ja2Agd2hlbiBjbG9zaW5nIHRoZSBmaWxlIG5vCiAgICAgIC8vIG1hdHRlciB3aGF0LiBEbyBub3RoaW5nIGlmIHRoZXJlJ3Mgbm8gbG9jayBjdXJyZW50bHkKICAgICAgaWYgKHRyYW5zKSB7CiAgICAgICAgLy8gVE9ETzogdGhpcyBpcyB3aGVyZSBhbiBlcnJvciBjb3VsZCBidWJibGUgdXAuIEhhbmRsZSBpdAogICAgICAgIGF3YWl0IHRyYW5zLndhaXRDb21wbGV0ZSgpOwogICAgICAgIHRyYW5zYWN0aW9ucy5kZWxldGUobmFtZSk7CiAgICAgIH0KICAgIH0KCiAgICB3cml0ZXIuaW50MzIoMCk7CiAgICB3cml0ZXIuZmluYWxpemUoKTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZVJlYWQod3JpdGVyLCBuYW1lLCBwb3NpdGlvbikgewogICAgcmV0dXJuIHdpdGhUcmFuc2FjdGlvbihuYW1lLCAncmVhZG9ubHknLCBhc3luYyB0cmFucyA9PiB7CiAgICAgIGxldCBkYXRhID0gYXdhaXQgdHJhbnMucmVhZChwb3NpdGlvbik7CgogICAgICBpZiAoZGF0YSA9PSBudWxsKSB7CiAgICAgICAgd3JpdGVyLmJ5dGVzKG5ldyBBcnJheUJ1ZmZlcigwKSk7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd3JpdGVyLmJ5dGVzKGRhdGEpOwogICAgICB9CiAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgfSk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBoYW5kbGVXcml0ZXMod3JpdGVyLCBuYW1lLCB3cml0ZXMpIHsKICAgIHJldHVybiB3aXRoVHJhbnNhY3Rpb24obmFtZSwgJ3JlYWR3cml0ZScsIGFzeW5jIHRyYW5zID0+IHsKICAgICAgYXdhaXQgdHJhbnMuYnVsa1NldCh3cml0ZXMubWFwKHcgPT4gKHsga2V5OiB3LnBvcywgdmFsdWU6IHcuZGF0YSB9KSkpOwoKICAgICAgd3JpdGVyLmludDMyKDApOwogICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgIH0pOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlUmVhZE1ldGEod3JpdGVyLCBuYW1lKSB7CiAgICByZXR1cm4gd2l0aFRyYW5zYWN0aW9uKG5hbWUsICdyZWFkb25seScsIGFzeW5jIHRyYW5zID0+IHsKICAgICAgdHJ5IHsKICAgICAgICBjb25zb2xlLmxvZygnUmVhZGluZyBtZXRhJyk7CiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHRyYW5zLmdldCgtMSk7CiAgICAgICAgY29uc29sZS5sb2coJ1JlYWRpbmcgbWV0YSAoZG9uZSknLCByZXMpOwoKICAgICAgICBsZXQgbWV0YSA9IHJlczsKICAgICAgICB3cml0ZXIuaW50MzIobWV0YSA/IG1ldGEuc2l6ZSA6IC0xKTsKICAgICAgICB3cml0ZXIuaW50MzIobWV0YSA/IG1ldGEuYmxvY2tTaXplIDogLTEpOwogICAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBjb25zb2xlLmxvZyhlcnIpOwogICAgICAgIHdyaXRlci5pbnQzMigtMSk7CiAgICAgICAgd3JpdGVyLmludDMyKC0xKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfQogICAgfSk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiBoYW5kbGVXcml0ZU1ldGEod3JpdGVyLCBuYW1lLCBtZXRhKSB7CiAgICByZXR1cm4gd2l0aFRyYW5zYWN0aW9uKG5hbWUsICdyZWFkd3JpdGUnLCBhc3luYyB0cmFucyA9PiB7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgdHJhbnMuc2V0KHsga2V5OiAtMSwgdmFsdWU6IG1ldGEgfSk7CgogICAgICAgIHdyaXRlci5pbnQzMigwKTsKICAgICAgICB3cml0ZXIuZmluYWxpemUoKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgY29uc29sZS5sb2coZXJyKTsKICAgICAgICB3cml0ZXIuaW50MzIoLTEpOwogICAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgICB9CiAgICB9KTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIGhhbmRsZURlbGV0ZUZpbGUod3JpdGVyLCBuYW1lKSB7CiAgICB0cnkgewogICAgICBjbG9zZURiKG5hbWUpOwoKICAgICAgYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewogICAgICAgIGxldCByZXEgPSBnbG9iYWxUaGlzLmluZGV4ZWREQi5kZWxldGVEYXRhYmFzZShuYW1lKTsKICAgICAgICByZXEub25zdWNjZXNzID0gcmVzb2x2ZTsKICAgICAgICByZXEub25lcnJvciA9IHJlamVjdDsKICAgICAgfSk7CgogICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgIHdyaXRlci5pbnQzMigtMSk7CiAgICAgIHdyaXRlci5maW5hbGl6ZSgpOwogICAgfQogIH0KCiAgYXN5bmMgZnVuY3Rpb24gaGFuZGxlQ2xvc2VGaWxlKHdyaXRlciwgbmFtZSkgewogICAgY2xvc2VEYihuYW1lKTsKCiAgICB3cml0ZXIuaW50MzIoMCk7CiAgICB3cml0ZXIuZmluYWxpemUoKTsKICB9CgogIC8vIGBsaXN0ZW5gIGNvbnRpbnVhbGx5IGxpc3RlbnMgZm9yIHJlcXVlc3RzIHZpYSB0aGUgc2hhcmVkIGJ1ZmZlci4KICAvLyBSaWdodCBub3cgaXQncyBpbXBsZW1lbnRlZCBpbiBhIHRhaWwtY2FsbCBzdHlsZSAoYGxpc3RlbmAgaXMKICAvLyByZWN1cnNpdmVseSBjYWxsZWQpIGJlY2F1c2UgSSB0aG91Z2h0IHRoYXQgd2FzIG5lY2Vzc2FyeSBmb3IKICAvLyB2YXJpb3VzIHJlYXNvbnMuIFdlIGNhbiBjb252ZXJ0IHRoaXMgdG8gYSBgd2hpbGUoMSlgIGxvb3Agd2l0aAogIC8vIGFuZCB1c2UgYGF3YWl0YCB0aG91Z2gKICBhc3luYyBmdW5jdGlvbiBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpIHsKICAgIGxldCBtZXRob2QgPSByZWFkZXIuc3RyaW5nKCk7CgogICAgc3dpdGNoIChtZXRob2QpIHsKICAgICAgY2FzZSAncHJvZmlsZS1zdGFydCc6IHsKICAgICAgICByZWFkZXIuZG9uZSgpOwoKICAgICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgICAgbGlzdGVuKHJlYWRlciwgd3JpdGVyKTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY2FzZSAncHJvZmlsZS1zdG9wJzogewogICAgICAgIHJlYWRlci5kb25lKCk7CiAgICAgICAgLy8gVGhlIHBlcmYgbGlicmFyeSBwb3N0cyBhIG1lc3NhZ2U7IG1ha2Ugc3VyZSBpdCBoYXMgdGltZSB0bwogICAgICAgIC8vIGFjdHVhbGx5IHBvc3QgaXQgYmVmb3JlIGJsb2NraW5nIHRoZSB0aHJlYWQgYWdhaW4KICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgMTAwMCkpOwoKICAgICAgICB3cml0ZXIuaW50MzIoMCk7CiAgICAgICAgd3JpdGVyLmZpbmFsaXplKCk7CiAgICAgICAgbGlzdGVuKHJlYWRlciwgd3JpdGVyKTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY2FzZSAnd3JpdGVCbG9ja3MnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHdyaXRlcyA9IFtdOwogICAgICAgIHdoaWxlICghcmVhZGVyLmRvbmUoKSkgewogICAgICAgICAgbGV0IHBvcyA9IHJlYWRlci5pbnQzMigpOwogICAgICAgICAgbGV0IGRhdGEgPSByZWFkZXIuYnl0ZXMoKTsKICAgICAgICAgIHdyaXRlcy5wdXNoKHsgcG9zLCBkYXRhIH0pOwogICAgICAgIH0KCiAgICAgICAgYXdhaXQgaGFuZGxlV3JpdGVzKHdyaXRlciwgbmFtZSwgd3JpdGVzKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdyZWFkQmxvY2snOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHBvcyA9IHJlYWRlci5pbnQzMigpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZVJlYWQod3JpdGVyLCBuYW1lLCBwb3MpOwogICAgICAgIGxpc3RlbihyZWFkZXIsIHdyaXRlcik7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KCiAgICAgIGNhc2UgJ3JlYWRNZXRhJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIHJlYWRlci5kb25lKCk7CiAgICAgICAgYXdhaXQgaGFuZGxlUmVhZE1ldGEod3JpdGVyLCBuYW1lKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICd3cml0ZU1ldGEnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IHNpemUgPSByZWFkZXIuaW50MzIoKTsKICAgICAgICBsZXQgYmxvY2tTaXplID0gcmVhZGVyLmludDMyKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKICAgICAgICBhd2FpdCBoYW5kbGVXcml0ZU1ldGEod3JpdGVyLCBuYW1lLCB7IHNpemUsIGJsb2NrU2l6ZSB9KTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdkZWxldGVGaWxlJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZURlbGV0ZUZpbGUod3JpdGVyLCBuYW1lKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICdjbG9zZUZpbGUnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKCiAgICAgICAgYXdhaXQgaGFuZGxlQ2xvc2VGaWxlKHdyaXRlciwgbmFtZSk7CiAgICAgICAgbGlzdGVuKHJlYWRlciwgd3JpdGVyKTsKICAgICAgICBicmVhazsKICAgICAgfQoKICAgICAgY2FzZSAnbG9ja0ZpbGUnOiB7CiAgICAgICAgbGV0IG5hbWUgPSByZWFkZXIuc3RyaW5nKCk7CiAgICAgICAgbGV0IGxvY2tUeXBlID0gcmVhZGVyLmludDMyKCk7CiAgICAgICAgcmVhZGVyLmRvbmUoKTsKCiAgICAgICAgYXdhaXQgaGFuZGxlTG9jayh3cml0ZXIsIG5hbWUsIGxvY2tUeXBlKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBjYXNlICd1bmxvY2tGaWxlJzogewogICAgICAgIGxldCBuYW1lID0gcmVhZGVyLnN0cmluZygpOwogICAgICAgIGxldCBsb2NrVHlwZSA9IHJlYWRlci5pbnQzMigpOwogICAgICAgIHJlYWRlci5kb25lKCk7CgogICAgICAgIGF3YWl0IGhhbmRsZVVubG9jayh3cml0ZXIsIG5hbWUsIGxvY2tUeXBlKTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICBkZWZhdWx0OgogICAgICAgIHRocm93IG5ldyBFcnJvcignVW5rbm93biBtZXRob2Q6ICcgKyBtZXRob2QpOwogICAgfQogIH0KCiAgc2VsZi5vbm1lc3NhZ2UgPSBtc2cgPT4gewogICAgc3dpdGNoIChtc2cuZGF0YS50eXBlKSB7CiAgICAgIGNhc2UgJ2luaXQnOiB7CiAgICAgICAgcG9zdE1lc3NhZ2UoeyB0eXBlOiAnX19hYnN1cmQ6d29ya2VyLXJlYWR5JyB9KTsKICAgICAgICBsZXQgW2FyZ0J1ZmZlciwgcmVzdWx0QnVmZmVyXSA9IG1zZy5kYXRhLmJ1ZmZlcnM7CiAgICAgICAgbGV0IHJlYWRlciA9IG5ldyBSZWFkZXIoYXJnQnVmZmVyLCB7IG5hbWU6ICdhcmdzJywgZGVidWc6IGZhbHNlIH0pOwogICAgICAgIGxldCB3cml0ZXIgPSBuZXcgV3JpdGVyKHJlc3VsdEJ1ZmZlciwgeyBuYW1lOiAncmVzdWx0cycsIGRlYnVnOiBmYWxzZSB9KTsKICAgICAgICBsaXN0ZW4ocmVhZGVyLCB3cml0ZXIpOwogICAgICAgIGJyZWFrOwogICAgICB9CiAgICB9CiAgfTsKCn0oKSk7Cgo=', null, false);
/* eslint-enable */

export default WorkerFactory;
